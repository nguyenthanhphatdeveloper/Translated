<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Chat English Tutor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://js.puter.com/v2/"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      font-family: 'Inter', sans-serif;
    }

    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Animation for chat bubbles */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }

    /* Waveform Animation */
    .waveform-bar {
      width: 4px;
      height: 20px;
      background: linear-gradient(to top, #8b5cf6, #a78bfa);
      border-radius: 2px;
      animation: wave 0.6s ease-in-out infinite;
    }

    .waveform-bar:nth-child(1) {
      animation-delay: 0s;
    }

    .waveform-bar:nth-child(2) {
      animation-delay: 0.1s;
    }

    .waveform-bar:nth-child(3) {
      animation-delay: 0.2s;
    }

    .waveform-bar:nth-child(4) {
      animation-delay: 0.1s;
    }

    .waveform-bar:nth-child(5) {
      animation-delay: 0s;
    }

    @keyframes wave {

      0%,
      100% {
        transform: scaleY(0.4);
        opacity: 0.6;
      }

      50% {
        transform: scaleY(1);
        opacity: 1;
      }
    }

    /* Pulsing button animation */
    @keyframes pulse-ring {
      0% {
        transform: scale(1);
        opacity: 0.8;
      }

      100% {
        transform: scale(1.5);
        opacity: 0;
      }
    }

    .recording-pulse::before {
      content: '';
      position: absolute;
      inset: -4px;
      border-radius: 0.5rem;
      background: rgba(239, 68, 68, 0.4);
      animation: pulse-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* Typing dots animation */
    .typing-dots::after {
      content: '...';
      display: inline-block;
      animation: typing 1.4s infinite;
    }

    @keyframes typing {

      0%,
      20% {
        content: '.';
      }

      40% {
        content: '..';
      }

      60%,
      100% {
        content: '...';
      }
    }

    /* Status icon pulse */
    @keyframes icon-pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .status-pulse {
      animation: icon-pulse 2s ease-in-out infinite;
    }

    /* Messenger-style typing indicator */
    .typing-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 12px 16px;
      background: #f0f0f0;
      border-radius: 18px;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: #90949c;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(1) {
      animation-delay: 0s;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes bounce {

      0%,
      60%,
      100% {
        transform: translateY(0);
      }

      30% {
        transform: translateY(-10px);
      }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  <!-- Unified Header -->
  <script src="/js/header.js"></script>

  <main class="max-w-5xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 md:py-8">
    <!-- Header -->
    <div class="mb-4 sm:mb-6 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
      <div>
        <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900 mb-1">Voice Chat English Tutor</h1>
        <p class="text-xs sm:text-sm text-gray-600">Luyện nói với AI (Web Speech API + Puter AI).</p>
      </div>
      <!-- Login Button for Puter -->
      <div id="authSection" class="hidden">
        <button id="loginBtn"
          class="flex items-center gap-2 px-4 py-2 bg-black text-white rounded-lg text-sm font-medium hover:bg-gray-800 transition-colors shadow-sm">
          <img src="https://puter.com/assets/favicon/favicon-32x32.png" class="w-4 h-4" alt="Puter">
          <span>Đăng nhập AI</span>
        </button>
      </div>
      <div id="userInfo"
        class="hidden flex items-center gap-2 px-3 py-1.5 bg-green-50 text-green-700 rounded-lg text-xs font-medium border border-green-100">
        <i class="fas fa-check-circle"></i>
        <span>AI Ready</span>
        <span id="userName" class="font-bold ml-1"></span>
      </div>
    </div>

    <!-- Controls -->
    <div class="bg-white rounded-lg shadow p-3 sm:p-4 md:p-5 mb-4 sm:mb-6">
      <!-- Error Alert -->
      <div id="errorAlert"
        class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm flex items-center justify-between gap-2">
        <div class="flex items-center gap-2">
          <i class="fas fa-exclamation-circle"></i>
          <span id="errorText">Lỗi kết nối</span>
        </div>
        <button id="errorLoginBtn"
          class="hidden px-3 py-1 bg-white border border-red-200 text-red-700 rounded hover:bg-red-50 text-xs font-bold">
          Login now
        </button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
        <div>
          <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Level</label>
          <select id="levelSelect"
            class="w-full px-3 sm:px-4 py-2.5 sm:py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 text-sm">
            <option value="A1">A1 (Beginner)</option>
            <option value="A2" selected>A2 (Elementary)</option>
            <option value="B1">B1 (Intermediate)</option>
            <option value="B2">B2 (Upper)</option>
            <option value="C1">C1 (Advanced)</option>
            <option value="C2">C2 (Mastery)</option>
          </select>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Topic</label>
          <select id="topicSelect"
            class="w-full px-3 sm:px-4 py-2.5 sm:py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 text-sm">
            <option value="greetings" selected>Greetings</option>
            <option value="introductions">Introductions</option>
            <option value="small-talk">Small talk</option>
            <option value="directions">Asking for directions</option>
            <option value="shopping">Shopping</option>
            <option value="restaurant">Restaurants</option>
            <option value="travel">Travel</option>
            <option value="job-interview">Job interviews</option>
            <option value="ielts-part-1">IELTS Speaking Part 1</option>
            <option value="ielts-part-2">IELTS Speaking Part 2</option>
            <option value="hobbies">Hobbies</option>
            <option value="work">Work & Career</option>
          </select>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Voice Source</label>
          <select id="voiceSourceSelect"
            class="w-full px-3 sm:px-4 py-2.5 sm:py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 text-sm">
            <option value="auto">Auto (Ưu tiên AI)</option>
            <option value="browser">Browser Only (Nhanh/Free)</option>
          </select>
        </div>
        <div class="flex items-end gap-2 flex-col sm:flex-row sm:items-center">
          <label class="flex items-center gap-2 text-xs sm:text-sm text-gray-700 cursor-pointer h-full pt-6">
            <input type="checkbox" id="autoListenToggle" class="h-4 w-4 text-purple-600 rounded">
            <span>Auto-Mic (Hội thoại liên tục)</span>
          </label>
        </div>
        <div>
          <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-1">Speed</label>
          <div class="flex items-center gap-2">
            <input type="range" id="ttsRate" min="0.7" max="1.3" step="0.1" value="1.0"
              class="w-full accent-purple-600">
            <span id="ttsRateValue" class="text-xs text-gray-700 w-10 text-right">1.0x</span>
          </div>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap items-center gap-3">
        <button id="recordBtn"
          class="relative px-5 py-2.5 bg-purple-600 text-white rounded-lg font-semibold text-sm flex items-center gap-2 shadow-sm hover:bg-purple-700 active:scale-95 transition-all select-none touch-none">
          <i class="fas fa-microphone"></i>
          <span id="recordBtnText">Hold SPACE to talk</span>
        </button>
        <button id="stopBtn"
          class="px-5 py-2.5 bg-gray-100 text-gray-800 rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed hidden">
          <i class="fas fa-stop"></i>
          <span>Stop</span>
        </button>

        <!-- Waveform Animation -->
        <div id="waveform" class="hidden flex items-center gap-0.5">
          <div class="waveform-bar"></div>
          <div class="waveform-bar"></div>
          <div class="waveform-bar"></div>
          <div class="waveform-bar"></div>
          <div class="waveform-bar"></div>
        </div>

        <div class="h-8 w-px bg-gray-200 mx-2 hidden sm:block"></div>

        <button id="replayBtn"
          class="px-4 py-2.5 bg-blue-50 text-blue-700 rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-blue-100 disabled:opacity-50"
          disabled>
          <i class="fas fa-volume-up"></i>
          <span class="hidden sm:inline">Replay</span>
        </button>
        <button id="clearBtn"
          class="px-4 py-2.5 bg-red-50 text-red-700 rounded-lg font-semibold text-sm flex items-center gap-2 hover:bg-red-100">
          <i class="fas fa-trash"></i>
          <span class="hidden sm:inline">Clear</span>
        </button>

        <div id="statusBadge"
          class="ml-auto text-xs px-3 py-1.5 rounded-full bg-gray-100 text-gray-600 font-medium whitespace-nowrap flex items-center gap-1.5">
          <i id="statusIcon" class="fas fa-circle text-[8px]"></i>
          <span id="statusText">Ready</span>
        </div>
      </div>

      <div id="micPermissionHint" class="hidden mt-2 text-xs text-yellow-600">
        <i class="fas fa-info-circle"></i> Vui lòng cho phép truy cập Microphone nếu được hỏi.
      </div>
    </div>

    <!-- Transcript -->
    <div class="bg-white rounded-lg shadow-sm border p-4 sm:p-5 h-[400px] sm:h-[500px] flex flex-col">
      <div class="flex justify-between items-center mb-3 border-b pb-2">
        <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
          <i class="fas fa-comments text-purple-600"></i> Transcript
        </h3>
        <span class="text-xs text-gray-400">Audio + Text History</span>
      </div>

      <div id="transcript" class="flex-1 overflow-y-auto space-y-4 pr-1 scroll-smooth">
        <div class="text-center py-10 text-gray-400 text-sm">
          <i class="fas fa-microphone text-2xl mb-2 opacity-30"></i>
          <p>Nhấn giữ phím SPACE hoặc nút Microphone để nói.</p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // --- Configuration & State ---
    const CONFIG = {
      silenceDelay: 1000,
      playbackRateDefault: 1.0,
      lang: 'en-US'
    };

    let state = {
      isRecording: false,
      isProcessing: false,
      isSpeaking: false,
      autoListen: false,
      history: [],
      mediaRecorder: null,
      audioChunks: [],
      recognition: null, // Web Speech Recognition instance
      lastAiText: ''
    };

    // --- DOM Elements ---
    const els = {
      recordBtn: document.getElementById('recordBtn'),
      recordBtnText: document.getElementById('recordBtnText'),
      stopBtn: document.getElementById('stopBtn'),
      replayBtn: document.getElementById('replayBtn'),
      clearBtn: document.getElementById('clearBtn'),
      transcript: document.getElementById('transcript'),
      statusBadge: document.getElementById('statusBadge'),
      statusText: document.getElementById('statusText'),
      statusIcon: document.getElementById('statusIcon'),
      waveform: document.getElementById('waveform'),
      errorAlert: document.getElementById('errorAlert'),
      errorText: document.getElementById('errorText'),
      level: document.getElementById('levelSelect'),
      topic: document.getElementById('topicSelect'),
      voiceSource: document.getElementById('voiceSourceSelect'),
      autoListen: document.getElementById('autoListenToggle'),
      ttsRate: document.getElementById('ttsRate'),
      ttsRateValue: document.getElementById('ttsRateValue'),
      micHint: document.getElementById('micPermissionHint')
    };

    // --- Utils ---
    const setStatus = (msg, type = 'neutral') => {
      els.statusText.textContent = msg;

      // Icon mapping
      const icons = {
        neutral: 'fa-circle',
        recording: 'fa-microphone',
        processing: 'fa-brain',
        speaking: 'fa-volume-up',
        error: 'fa-exclamation-circle'
      };

      // Color mapping
      const colors = {
        neutral: 'bg-gray-100 text-gray-600',
        recording: 'bg-red-100 text-red-600',
        processing: 'bg-yellow-100 text-yellow-700',
        speaking: 'bg-green-100 text-green-700',
        error: 'bg-red-100 text-red-700'
      };

      // Update icon
      els.statusIcon.className = `fas ${icons[type] || icons.neutral} text-[10px]`;

      // Add pulse to icon for processing
      if (type === 'processing') {
        els.statusIcon.classList.add('status-pulse');
        els.statusText.classList.add('typing-dots');
      } else {
        els.statusIcon.classList.remove('status-pulse');
        els.statusText.classList.remove('typing-dots');
      }

      // Add pulse to badge for recording
      els.statusBadge.className = `ml-auto text-xs px-3 py-1.5 rounded-full font-medium whitespace-nowrap flex items-center gap-1.5 transition-all ${colors[type] || colors.neutral}`;
      if (type === 'recording') {
        els.statusBadge.classList.add('animate-pulse');
      }
    };

    const showError = (msg) => {
      els.errorText.textContent = msg;
      els.errorAlert.classList.remove('hidden');
      setTimeout(() => els.errorAlert.classList.add('hidden'), 8000);
      setStatus('Error', 'error');
    };

    const appendBubble = (role, text) => {
      if (!text) return;
      const isUser = role === 'user';
      // Remove empty state placeholder if exists
      if (els.transcript.querySelector('.text-center.py-10')) {
        els.transcript.innerHTML = '';
      }

      const div = document.createElement('div');
      div.className = `flex ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in`;

      const bubble = document.createElement('div');
      bubble.className = `max-w-[85%] sm:max-w-[75%] rounded-2xl px-4 py-3 text-sm sm:text-base leading-relaxed shadow-sm ${isUser
        ? 'bg-purple-600 text-white rounded-tr-none'
        : 'bg-gray-100 text-gray-800 rounded-tl-none border border-gray-200'
        }`;

      const meta = document.createElement('div');
      meta.className = `text-[10px] uppercase font-bold mb-1 opacity-70 ${isUser ? 'text-purple-100' : 'text-gray-500'}`;
      meta.textContent = isUser ? 'You' : 'AI Tutor';

      const content = document.createElement('div');
      content.textContent = text;

      bubble.appendChild(meta);
      bubble.appendChild(content);
      div.appendChild(bubble);
      els.transcript.appendChild(div);
      els.transcript.scrollTop = els.transcript.scrollHeight;
    };

    // Show Messenger-style typing indicator
    const showTypingIndicator = () => {
      // Remove if already exists
      hideTypingIndicator();

      // Remove empty state if exists
      if (els.transcript.querySelector('.text-center.py-10')) {
        els.transcript.innerHTML = '';
      }

      const div = document.createElement('div');
      div.className = 'flex justify-start animate-fade-in';
      div.id = 'typingIndicatorBubble';

      const bubble = document.createElement('div');
      bubble.className = 'max-w-[85%] sm:max-w-[75%] rounded-2xl px-4 py-3 bg-gray-100 rounded-tl-none border border-gray-200 shadow-sm';

      const meta = document.createElement('div');
      meta.className = 'text-[10px] uppercase font-bold mb-1 opacity-70 text-gray-500';
      meta.textContent = 'AI Tutor';

      const indicator = document.createElement('div');
      indicator.className = 'typing-indicator';
      indicator.innerHTML = '<span></span><span></span><span></span>';

      bubble.appendChild(meta);
      bubble.appendChild(indicator);
      div.appendChild(bubble);
      els.transcript.appendChild(div);
      els.transcript.scrollTop = els.transcript.scrollHeight;
    };

    // Hide typing indicator
    const hideTypingIndicator = () => {
      const existing = document.getElementById('typingIndicatorBubble');
      if (existing) {
        existing.remove();
      }
    };

    // --- Capability Checks ---
    const hasPuter = () => typeof window.puter !== 'undefined' && window.puter.ai;
    const hasSpeechRec = () => 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
    const hasSpeechSyn = () => 'speechSynthesis' in window;

    // --- Text-to-Speech Logic ---
    const speakText = async (text) => {
      if (!text) return;
      if (state.isSpeaking) return; // Debounce

      state.isSpeaking = true;
      setStatus('Speaking...', 'speaking');

      const rate = parseFloat(els.ttsRate.value);
      const useBrowser = els.voiceSource.value === 'browser' || !hasPuter();

      // Try Puter TTS first (High Quality)
      if (!useBrowser) {
        try {
          // Check if Puter works by a dry call or just try it
          const audioResult = await puter.ai.txt2speech({
            text: text,
            voice: 'en-US'
          });

          let audioUrl = null;
          if (audioResult) {
            if (typeof audioResult === 'string') audioUrl = audioResult;
            else if (audioResult.src) audioUrl = audioResult.src;
            else if (audioResult.url) audioUrl = audioResult.url;
            else if (audioResult instanceof Audio) {
              audioUrl = audioResult.src;
            }
          }

          if (audioUrl) {
            const audio = new Audio(audioUrl);
            audio.playbackRate = rate;

            await new Promise((resolve, reject) => {
              audio.onended = resolve;
              audio.onerror = reject;
              audio.play().catch(reject);
            });
            state.isSpeaking = false;
            setStatus('Ready');
            checkAutoListen();
            return; // Success
          }
        } catch (e) {
          console.warn('Puter TTS failed', e);
          // Fallback to browser
        }
      }

      // Browser TTS Fallback (Standard Quality, Free)
      if (hasSpeechSyn()) {
        try {
          // Cancel previous utterances
          speechSynthesis.cancel();

          // Wait a tick for cancellation to take effect
          await new Promise(r => setTimeout(r, 50));

          const u = new SpeechSynthesisUtterance(text);
          u.lang = 'en-US';
          u.rate = rate; // 0.1 to 10
          u.pitch = 1.0;

          // Prefer English Female Voice
          const voices = speechSynthesis.getVoices();
          const pVoice = voices.find(v => v.lang.includes('en-US') && v.name.includes('Female'))
            || voices.find(v => v.lang.includes('en-US'))
            || voices.find(v => v.lang.includes('en'));
          if (pVoice) u.voice = pVoice;

          await new Promise((resolve) => {
            u.onend = resolve;
            u.onerror = (e) => {
              console.warn("TTS Error", e);
              resolve(); // resolve anyway to not block app
            };
            speechSynthesis.speak(u);
          });
        } catch (e) {
          console.error('Browser TTS error', e);
          showError('Cannot play audio (TTS failed).');
        }
      } else {
        showError('No Text-to-Speech support in this browser.');
      }

      state.isSpeaking = false;
      setStatus('Ready');
      checkAutoListen();
    };

    const checkAutoListen = () => {
      if (els.autoListen.checked && !state.isRecording) {
        setTimeout(() => {
          if (!state.isRecording && !state.isSpeaking) {
            startRecording();
          }
        }, CONFIG.silenceDelay);
      }
    };

    // --- Speech-to-Text Logic ---
    const startRecording = async () => {
      if (state.isRecording || state.isProcessing || state.isSpeaking) return;

      // Reset
      state.audioChunks = [];
      state.isRecording = true;

      // Update UI - Show waveform and pulsing effect
      els.recordBtn.classList.add('bg-red-600', 'recording-pulse');
      els.recordBtn.classList.remove('bg-purple-600', 'shadow-sm');
      els.recordBtnText.textContent = 'Listening...';
      els.waveform.classList.remove('hidden');
      els.waveform.classList.add('flex');
      setStatus('Listening...', 'recording');
      els.micHint.classList.remove('hidden');

      // 1. Try Browser Native Speech Recognition (Real-time, Best for Chat)
      if (hasSpeechRec()) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        state.recognition = new SpeechRecognition();
        state.recognition.lang = 'en-US';
        state.recognition.interimResults = false;
        state.recognition.maxAlternatives = 1;

        state.recognition.onresult = (event) => {
          const txt = event.results[0][0].transcript;
          console.log('STT Result:', txt);
          handleUserSpeech(txt);
        };

        state.recognition.onerror = (event) => {
          console.warn('Speech recognition error', event.error);

          // Ignore harmless errors
          if (event.error === 'no-speech') {
            // User didn't say anything - ignore
            return;
          }
          if (event.error === 'aborted') {
            // User released button too fast - ignore
            return;
          }

          // Handle serious errors
          if (event.error === 'not-allowed') {
            showError('Microphone permission denied.');
            stopRecording();
            return;
          }
          if (event.error === 'audio-capture') {
            showError('Microphone busy or unavailable.');
            stopRecording();
            return;
          }

          // For other unexpected errors
          console.error('Unexpected recognition error:', event.error);
          stopRecording();
        };

        state.recognition.onend = () => {
          if (state.isRecording) {
            stopRecording(); // Logic flow: stop recording UI when recognition ends
          }
        };

        try {
          state.recognition.start();
          els.micHint.classList.add('hidden');
        } catch (e) {
          console.error("Start Rec Error", e);
          showError('Could not start recognition.');
          stopRecording();
        }
      }
      // 2. Fallback: MediaRecorder (Legacy/File based)
      else {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          state.mediaRecorder = new MediaRecorder(stream);
          state.mediaRecorder.ondataavailable = e => state.audioChunks.push(e.data);
          state.mediaRecorder.start();
          els.micHint.classList.add('hidden');
        } catch (e) {
          showError('Microphone access denied / Not supported.');
          stopRecording();
        }
      }
    };

    const stopRecording = async () => {
      if (!state.isRecording) return;
      state.isRecording = false;

      // Update UI - Hide waveform and remove pulse
      els.recordBtn.classList.remove('bg-red-600', 'recording-pulse');
      els.recordBtn.classList.add('bg-purple-600', 'shadow-sm');
      els.recordBtnText.textContent = hasSpeechRec() ? 'Hold SPACE to talk' : 'Hold to talk';
      els.waveform.classList.add('hidden');
      els.waveform.classList.remove('flex');
      setStatus('Processing...', 'processing');

      // Stop sources
      if (state.recognition) {
        try { state.recognition.stop(); } catch (e) { }
        // Rec onend will handle the rest
      } else if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
        state.mediaRecorder.stop();
        // Wait a bit for audio processing
        setTimeout(processAudioBlob, 500);
      } else {
        // If we just clicked stop without having started properly
        setStatus('Ready');
      }
    };

    const processAudioBlob = async () => {
      // Only used if SpeechRecognition was NOT used
      if (state.audioChunks.length === 0) {
        setStatus('Ready');
        return;
      }

      const blob = new Blob(state.audioChunks, { type: 'audio/webm' });
      state.audioChunks = []; // Reset

      if (!hasPuter()) {
        showError('Browser STT failed and Puter.js not available.');
        setStatus('Ready');
        return;
      }

      try {
        const text = await puter.ai.speech2txt({
          audio: blob,
          language: 'English'
        });
        handleUserSpeech(text);
      } catch (e) {
        console.error("Puter STT failed", e);
        showError('Transcription failed. Try speaking louder.');
        setStatus('Ready');
      }
    };

    // --- AI Processing ---
    const handleUserSpeech = async (text) => {
      if (!text || !text.trim()) {
        setStatus('Ready');
        return;
      }

      appendBubble('user', text);
      state.isProcessing = true;

      // Show typing indicator
      showTypingIndicator();
      setStatus('AI Thinking...', 'processing');

      // Construct Prompt
      const level = els.level.value;
      const topic = els.topic.value;
      const systemPrompt = `You are a friendly English conversation partner.
Level: ${level}. Topic: ${topic}.
Your goal: Have a natural, encouraging conversation.

Rules:
1. DO NOT correct grammar or punctuation unless it prevents understanding
2. Reply naturally in 10-20 words maximum
3. Ask ONE simple follow-up question to keep conversation going
4. Be warm and supportive - focus on communication, not perfection
5. Speak like a real person, not a teacher`;

      // Call AI
      let aiResponse = '';
      if (hasPuter()) {
        try {
          // Fast prompt with timeout
          const prompt = `${systemPrompt}\n\nUser: ${text}\nYou:`;

          // 8 second timeout for faster fallback
          const aiCall = puter.ai.chat(prompt);
          const timeout = new Promise((_, reject) =>
            setTimeout(() => reject(new Error('timeout')), 8000)
          );

          const resp = await Promise.race([aiCall, timeout]);

          // Parse response safely
          if (typeof resp === 'string') {
            aiResponse = resp;
          } else if (resp?.message?.content) {
            aiResponse = resp.message.content;
          } else if (resp?.choices?.[0]?.message?.content) {
            aiResponse = resp.choices[0].message.content;
          } else if (resp?.content) {
            aiResponse = resp.content;
          }
        } catch (e) {
          console.error('AI error:', e);

          const isTimeout = e.message?.includes('timeout');
          const isAuthError = e.message?.includes('auth') || e.message?.includes('Unauthorized') || e.message?.includes('401');

          if (isAuthError) {
            showError('Vui lòng đăng nhập Puter.');
            elsAuth.errorLogin.classList.remove('hidden');
            aiResponse = `I heard: "${text}". (Login to Puter)`;
          } else if (isTimeout) {
            showError('AI chậm, dùng echo.');
            aiResponse = `"${text}" - Great!`;
          } else {
            showError('AI bận!');
            aiResponse = `"${text}" - Good job!`;
          }
        }
      } else {
        // No Puter - use simple echo
        aiResponse = `You said: "${text}". (AI offline - please log in to Puter)`;
      }

      // Always ensure we have a response
      if (!aiResponse || aiResponse.trim() === '') {
        aiResponse = "Sorry, I couldn't process that. Please try again.";
      }

      state.lastAiText = aiResponse;
      // Keep minimal history (last 2 exchanges only)
      if (state.history.length > 4) state.history = state.history.slice(-2);
      state.history.push({ role: 'user', content: text });
      state.history.push({ role: 'assistant', content: aiResponse });

      // Hide typing indicator before showing response
      hideTypingIndicator();

      appendBubble('ai', aiResponse);
      els.replayBtn.disabled = false;

      state.isProcessing = false;
      await speakText(aiResponse);
    };

    // --- Auth Logic ---
    const elsAuth = {
      section: document.getElementById('authSection'),
      loginBtn: document.getElementById('loginBtn'),
      userInfo: document.getElementById('userInfo'),
      userName: document.getElementById('userName'),
      errorLogin: document.getElementById('errorLoginBtn')
    };

    const checkAuth = async () => {
      if (!hasPuter()) return;
      try {
        // Try to get user info. If 401, this throws or returns null
        const user = await puter.auth.getUser();
        if (user) {
          showUser(user);
        } else {
          showLogin();
        }
      } catch (e) {
        // 401 usually ends up here
        showLogin();
      }
    };

    const showLogin = () => {
      elsAuth.section.classList.remove('hidden');
      elsAuth.userInfo.classList.add('hidden');
    };

    const showUser = (user) => {
      elsAuth.section.classList.add('hidden');
      elsAuth.userInfo.classList.remove('hidden');
      elsAuth.userName.textContent = user.username || 'User';
    };

    const performLogin = async () => {
      if (!hasPuter()) return;
      try {
        const user = await puter.auth.signIn();
        showUser(user);
        els.errorAlert.classList.add('hidden');
      } catch (e) {
        console.error("Login failed", e);
        showError('Đăng nhập thất bại. Vui lòng thử lại.');
      }
    };

    elsAuth.loginBtn.addEventListener('click', performLogin);
    elsAuth.errorLogin.addEventListener('click', performLogin);

    // --- Interaction Handlers ---

    // START
    const handleStart = (e) => {
      // Only start if not already recording/processing
      if (!state.isRecording && !state.isProcessing && !state.isSpeaking) {
        e.preventDefault(); // Stop text selection
        startRecording();
      }
    };

    // STOP
    const handleStop = (e) => {
      if (state.isRecording) {
        e.preventDefault();
        stopRecording();
      }
    };

    // Button Events
    els.recordBtn.addEventListener('mousedown', handleStart);
    els.recordBtn.addEventListener('touchstart', handleStart);

    window.addEventListener('mouseup', handleStop);
    window.addEventListener('touchend', handleStop);

    // Spacebar PTT
    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && !e.repeat && !state.isRecording && document.activeElement.tagName !== 'INPUT') {
        e.preventDefault();
        startRecording();
      }
    });
    window.addEventListener('keyup', (e) => {
      if (e.code === 'Space' && state.isRecording) {
        e.preventDefault();
        stopRecording();
      }
    });

    els.clearBtn.addEventListener('click', () => {
      els.transcript.innerHTML = '';
      state.history = [];
      els.replayBtn.disabled = true;
      setStatus('Cleared');
      setTimeout(() => setStatus('Ready'), 1000);

      // Restore empty placeholder
      els.transcript.innerHTML = `
        <div class="text-center py-10 text-gray-400 text-sm">
          <i class="fas fa-microphone text-2xl mb-2 opacity-30"></i>
          <p>Nhấn giữ phím SPACE hoặc nút Microphone để nói.</p>
        </div>
      `;
    });

    els.replayBtn.addEventListener('click', () => {
      if (state.lastAiText) speakText(state.lastAiText);
    });

    els.ttsRate.addEventListener('input', (e) => {
      els.ttsRateValue.textContent = e.target.value + 'x';
    });

    // Load voices for Web Speech API
    if (window.speechSynthesis) {
      window.speechSynthesis.getVoices();
    }

    // Init Auth Check
    setTimeout(checkAuth, 1000);
  </script>
</body>

</html>