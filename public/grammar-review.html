<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√în t·∫≠p Grammar (SRS)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
  <nav class="bg-white shadow-sm border-b">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16 items-center">
        <a href="/" class="text-xl font-bold text-purple-600">üìö English Vocab</a>
        <div class="flex items-center space-x-4 text-sm">
          <a href="/learn" class="text-gray-600 hover:text-purple-600">H·ªçc t·ª´</a>
          <a href="/assessment" class="text-gray-600 hover:text-purple-600">Test Level</a>
          <a href="/missions" class="text-gray-600 hover:text-purple-600">Missions</a>
          <a href="/ipa" class="text-gray-600 hover:text-purple-600">Luy·ªán IPA</a>
          <a href="/practice" class="text-gray-600 hover:text-purple-600">Luy·ªán t·∫≠p</a>
          <a href="/review" class="text-gray-600 hover:text-purple-600">√în t·ª´</a>
          <a href="/grammar" class="text-gray-600 hover:text-purple-600">Grammar</a>
          <a href="/grammar-review" class="text-purple-600 font-semibold">Grammar Review</a>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">√în t·∫≠p Grammar (SRS)</h1>
        <p class="text-sm text-gray-600">ƒê√°nh gi√° Again/Hard/Good/Easy ƒë·ªÉ l√™n l·ªãch √¥n.</p>
      </div>
      <button id="btnRefresh" class="px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700">
        <i class="fas fa-rotate mr-1"></i>T·∫£i l·∫°i
      </button>
    </div>

    <div id="summary" class="flex items-center gap-3 text-sm mb-4">
      <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full">C·∫ßn √¥n h√¥m nay: <span id="needReview">0</span></span>
      <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full">T·ªïng grammar ƒë√£ l∆∞u: <span id="saved">0</span></span>
    </div>

    <div id="queue" class="space-y-4"></div>
    <div id="empty" class="hidden text-center py-10 text-gray-500">Ch∆∞a c√≥ grammar c·∫ßn √¥n. H√£y th√™m t·ª´ trang Grammar.</div>
  </main>

  <script src="/js/storage.js"></script>
  <script>
    // reuse StorageManager but extend simple grammar list
    const storage = new StorageManager();
    const KEY = 'grammar_review_v1';

    function loadGrammarQueue(){
      try{
        const raw = localStorage.getItem(KEY);
        if(!raw) return [];
        return JSON.parse(raw);
      }catch{return [];}
    }
    function saveGrammarQueue(list){
      localStorage.setItem(KEY, JSON.stringify(list));
    }

    function getDue(list){
      const today = new Date().toISOString().split('T')[0];
      return list.filter(i=> !i.nextReview || i.nextReview.split('T')[0] <= today);
    }

    function render(){
      const list = loadGrammarQueue();
      const due = getDue(list);
      document.getElementById('needReview').textContent = due.length;
      document.getElementById('saved').textContent = list.length;
      const q = document.getElementById('queue');
      const empty = document.getElementById('empty');
      if(!due.length){
        q.innerHTML=''; empty.classList.remove('hidden'); return;
      }
      empty.classList.add('hidden');
      q.innerHTML = due.map((g,idx)=>`
        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-xs px-2 py-1 rounded bg-blue-50 text-blue-700">${g.level||'N/A'}</span>
              <span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700">${g.super||''}</span>
              ${g.sub ? `<span class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-700">${g.sub}</span>` : ''}
            </div>
            <span class="text-xs text-gray-500">L·∫ßn √¥n: ${g.reviewCount||0}</span>
          </div>
          <p class="font-semibold text-gray-900 mb-1">${g.guide||''}</p>
          <p class="text-sm text-gray-700 mb-2 whitespace-pre-line">${g.cando||''}</p>
          ${g.example ? `<div class="text-xs text-gray-600 bg-gray-50 rounded p-2 whitespace-pre-line">${g.example}</div>` : ''}
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-3">
            ${['again','hard','good','easy'].map(r=>`
              <button data-id="${g.id}" data-rate="${r}" class="btn-rate px-3 py-2 text-sm rounded ${
                r==='again'?'bg-red-50 text-red-700':
                r==='hard'?'bg-yellow-50 text-yellow-700':
                r==='good'?'bg-green-50 text-green-700':
                'bg-blue-50 text-blue-700'
              }">${r}</button>
            `).join('')}
          </div>
        </div>
      `).join('');
      document.querySelectorAll('.btn-rate').forEach(btn=>{
        btn.onclick = ()=> rate(btn.dataset.id, btn.dataset.rate);
      });
    }

    function rate(id, rating){
      const list = loadGrammarQueue();
      const item = list.find(i=>i.id==id);
      if(!item) return;
      item.reviewCount = (item.reviewCount||0)+1;
      const daysMap = {again:1, hard:3, good:7, easy:14};
      const days = daysMap[rating]||7;
      const d = new Date(); d.setDate(d.getDate()+days);
      item.nextReview = d.toISOString();
      saveGrammarQueue(list);
      render();
    }

    // Quick add from URL params ?add=ID
    async function maybeAddFromQuery(){
      const params = new URLSearchParams(location.search);
      const addId = params.get('add');
      if(!addId) return;
      try{
        const res = await fetch('/api/grammar/points?limit=1&page='+(Number(addId)+1)); // simplistic, expects id=index
        const data = (await res.json()).data;
        if(data && data.length){
          const g = data[0];
          const list = loadGrammarQueue();
          list.push({
            id: Date.now(),
            guide: g['Guideword'],
            cando: g['Can-do statement'],
            example: g.Example,
            level: g.Level,
            super: g.SuperCategory,
            sub: g.SubCategory,
            reviewCount: 0,
            nextReview: null
          });
          saveGrammarQueue(list);
        }
      }catch(e){console.error(e);}
    }

    document.getElementById('btnRefresh').onclick = render;
    window.addEventListener('DOMContentLoaded', ()=>{ maybeAddFromQuery(); render(); });
  </script>
</body>
</html>

