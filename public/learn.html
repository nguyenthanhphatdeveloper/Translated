<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H·ªçc T·ª´ V·ª±ng - English Vocabulary Learning</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }

    .level-badge {
      padding: 4px 10px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
      line-height: 1;
    }
    .level-A1 { background: #d1fae5; color: #065f46; }
    .level-A2 { background: #dbeafe; color: #1d4ed8; }
    .level-B1 { background: #fef9c3; color: #92400e; }
    .level-B2 { background: #ffedd5; color: #9a3412; }
    .level-C1 { background: #fee2e2; color: #b91c1c; }
    .level-C2 { background: #ede9fe; color: #6d28d9; }

    .word-card {
      transition: all 0.3s ease;
    }
    .word-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <a href="/" class="text-xl font-bold text-purple-600">üìö English Vocab</a>
        </div>
        <div class="flex items-center space-x-4">
          <a href="/learn" class="text-purple-600 font-medium">H·ªçc t·ª´</a>
          <a href="/assessment" class="text-gray-600 hover:text-purple-600">Test Level</a>
          <a href="/ipa" class="text-gray-600 hover:text-purple-600">Luy·ªán IPA</a>
          <a href="/combo" class="text-gray-600 hover:text-purple-600">Combo</a>
          <a href="/quiz-mix" class="text-gray-600 hover:text-purple-600">Quiz Mix</a>
          <a href="/grammar" class="text-gray-600 hover:text-purple-600">Grammar</a>
          <a href="/review" class="text-gray-600 hover:text-purple-600">√în t·ª´</a>
          <a href="/review-grammar" class="text-gray-600 hover:text-purple-600">√în Grammar</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">H·ªçc T·ª´ V·ª±ng M·ªõi</h1>
      <p class="text-gray-600">Ch·ªçn level v√† b·∫Øt ƒë·∫ßu h·ªçc t·ª´ v·ª±ng ti·∫øng Anh</p>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">C·∫•p ƒë·ªô</label>
          <select id="levelFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" onchange="handleLevelChange()">
            <option value="">T·∫•t c·∫£</option>
            <option value="A1">A1 - Beginner</option>
            <option value="A2">A2 - Elementary</option>
            <option value="B1">B1 - Intermediate</option>
            <option value="B2">B2 - Upper Intermediate</option>
            <option value="C1">C1 - Advanced</option>
            <option value="C2">C2 - Proficient</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">T√¨m ki·∫øm</label>
          <input type="text" id="searchInput" placeholder="Nh·∫≠p t·ª´ c·∫ßn t√¨m..." 
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Ch·ªß ƒë·ªÅ</label>
          <select id="topicFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <option value="">T·∫•t c·∫£ ch·ªß ƒë·ªÅ</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">S·ªë t·ª´ hi·ªÉn th·ªã</label>
          <select id="limitSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <option value="20">20 t·ª´</option>
            <option value="50" selected>50 t·ª´</option>
            <option value="100">100 t·ª´</option>
          </select>
        </div>
      </div>
      <button onclick="loadWords()" class="mt-4 w-full md:w-auto px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
        <i class="fas fa-search mr-2"></i>T√¨m ki·∫øm
      </button>
    </div>

    <!-- Stats -->
    <div id="stats" class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
      <!-- Stats will be loaded here -->
    </div>
    <div id="topTopics" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-6"></div>

    <!-- Word List -->
    <div id="wordList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- Words will be loaded here -->
    </div>

    <!-- Loading -->
    <div id="loading" class="text-center py-12 hidden">
      <i class="fas fa-spinner fa-spin text-4xl text-purple-600"></i>
      <p class="mt-4 text-gray-600">ƒêang t·∫£i...</p>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="mt-8 flex justify-center">
      <!-- Pagination will be loaded here -->
    </div>
  </div>

  <!-- Word Detail Modal -->
  <div id="wordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
        <h2 id="modalWord" class="text-2xl font-bold"></h2>
        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      <div id="modalContent" class="p-6">
        <!-- Word details will be loaded here -->
      </div>
    </div>
  </div>

  <script src="/js/vocabulary.js"></script>
  <script src="/js/storage.js"></script>
  <script src="/js/command.js"></script>
  <script>
    const storage = new StorageManager();
    const DICT_CACHE_KEY = 'dictionary_cache_v1';
    let dictionaryCache = loadDictCache();
    let currentPage = 1;
    let currentFilters = {};

    function loadDictCache() {
      try {
        const cached = localStorage.getItem(DICT_CACHE_KEY);
        return cached ? JSON.parse(cached) : {};
      } catch (e) {
        console.warn('Cannot load dictionary cache:', e);
        return {};
      }
    }

    function saveDictCache() {
      try {
        localStorage.setItem(DICT_CACHE_KEY, JSON.stringify(dictionaryCache));
      } catch (e) {
        console.warn('Cannot save dictionary cache:', e);
      }
    }

    // Load words on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadStats();
      loadTopics();
      loadTopTopics();
      loadWords();
    });

    function handleLevelChange() {
      const level = document.getElementById('levelFilter').value;
      loadTopics(level);
      loadTopTopics(level);
    }

    // Load statistics
    async function loadStats() {
      try {
        const response = await fetch('/api/vocabulary/stats');
        const stats = await response.json();
        
        const statsHtml = `
          <div class="bg-white rounded-lg shadow p-4 text-center">
            <div class="text-2xl font-bold text-gray-900">${stats.total.toLocaleString()}</div>
            <div class="text-sm text-gray-600">T·ªïng s·ªë t·ª´</div>
          </div>
          ${['A1', 'A2', 'B1', 'B2', 'C1', 'C2'].map(level => `
            <div class="bg-white rounded-lg shadow p-4 text-center">
              <div class="text-xl font-bold level-${level}">${stats.byLevel[level] || 0}</div>
              <div class="text-xs text-gray-600 mt-1">Level ${level}</div>
            </div>
          `).join('')}
        `;
        document.getElementById('stats').innerHTML = statsHtml;
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load words
    async function loadWords(page = 1) {
      const loading = document.getElementById('loading');
      const wordList = document.getElementById('wordList');
      
      loading.classList.remove('hidden');
      wordList.innerHTML = '';

      const level = document.getElementById('levelFilter').value;
      const search = document.getElementById('searchInput').value;
      const topic = document.getElementById('topicFilter').value;
      const limit = document.getElementById('limitSelect').value;

      currentFilters = { level, search, topic, limit, page };

      try {
        const params = new URLSearchParams({
          page,
          limit,
          ...(level && { level }),
          ...(topic && { topic }),
          ...(search && { search })
        });

        const response = await fetch(`/api/vocabulary/words?${params}`);
        const data = await response.json();

        if (data.data.length === 0) {
          wordList.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">Kh√¥ng t√¨m th·∫•y t·ª´ n√†o</div>';
        } else {
          wordList.innerHTML = data.data.map((word, index) => {
            const progress = storage.getWordProgress(word['Base Word']);
            const isLearned = progress && progress.status !== 'learning';
            
            return `
              <div class="word-card bg-white rounded-lg shadow p-6 cursor-pointer" onclick="showWordDetail('${word['Base Word']}', ${data.pagination.page * data.pagination.limit - data.pagination.limit + index})">
                <div class="flex justify-between items-start mb-3">
                  <h3 class="text-xl font-bold text-gray-900">${word['Base Word']}</h3>
                  <span class="level-badge level-${word.Level}">${word.Level}</span>
                </div>
                ${word.Guideword ? `<p class="text-sm text-gray-600 mb-2">${word.Guideword}</p>` : ''}
                ${word.Translate ? `<p class="text-sm text-purple-600 mb-2 font-medium">${word.Translate}</p>` : ''}
                <p class="text-sm text-gray-500 mb-3">
                  <i class="fas a-tag mr-1"></i>${word['Part of Speech'] || 'N/A'}
                  ${word.Topic ? `<span class="ml-2"><i class="fas fa-folder mr-1"></i>${word.Topic}</span>` : ''}
                </p>
                ${isLearned ? '<span class="text-green-600 text-sm"><i class="fas fa-check-circle mr-1"></i>ƒê√£ h·ªçc</span>' : ''}
                <button onclick="event.stopPropagation(); markAsLearned('${word['Base Word']}', ${data.pagination.page * data.pagination.limit - data.pagination.limit + index})" 
                  class="mt-3 w-full px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition text-sm">
                  <i class="fas fa-bookmark mr-2"></i>ƒê√°nh d·∫•u ƒë√£ h·ªçc
                </button>
              </div>
            `;
          }).join('');

          // Pagination
          if (data.pagination.totalPages > 1) {
            const paginationHtml = `
              <div class="flex items-center space-x-2">
                <button onclick="loadWords(${page - 1})" ${page === 1 ? 'disabled' : ''} 
                  class="px-4 py-2 border rounded-lg ${page === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50'}">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <span class="px-4 py-2">Trang ${page} / ${data.pagination.totalPages}</span>
                <button onclick="loadWords(${page + 1})" ${page === data.pagination.totalPages ? 'disabled' : ''} 
                  class="px-4 py-2 border rounded-lg ${page === data.pagination.totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-50'}">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            `;
            document.getElementById('pagination').innerHTML = paginationHtml;
          }
        }
      } catch (error) {
        console.error('Error loading words:', error);
        wordList.innerHTML = '<div class="col-span-full text-center py-12 text-red-500">L·ªói khi t·∫£i d·ªØ li·ªáu</div>';
      } finally {
        loading.classList.add('hidden');
      }
    }

    // Load topics (optionally by level)
    async function loadTopics(level = '') {
      const topicSelect = document.getElementById('topicFilter');
      topicSelect.innerHTML = '<option value="">T·∫•t c·∫£ ch·ªß ƒë·ªÅ</option>';
      try {
        const params = level ? `?level=${level}` : '';
        const res = await fetch(`/api/vocabulary/topics${params}`);
        const data = await res.json();
        (data.data || []).forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.topic;
          opt.textContent = `${item.topic} (${item.count})`;
          topicSelect.appendChild(opt);
        });
      } catch (e) {
        console.error('Error loading topics:', e);
      }
    }

    // Load top topics for selected level
    async function loadTopTopics(level = '') {
      const container = document.getElementById('topTopics');
      container.innerHTML = '';
      try {
        const params = level ? `?level=${level}` : '';
        const res = await fetch(`/api/vocabulary/topics${params}`);
        const data = await res.json();
        const topics = (data.data || []).slice(0, 8);
        container.innerHTML = topics.map(t => `
          <div class="bg-white rounded-lg shadow p-3 flex items-center justify-between">
            <span class="text-sm text-gray-800">${t.topic}</span>
            <span class="text-xs font-semibold text-purple-700 bg-purple-50 px-2 py-1 rounded">${t.count}</span>
          </div>
        `).join('') || '<div class="text-sm text-gray-500">Kh√¥ng c√≥ ch·ªß ƒë·ªÅ</div>';
      } catch (e) {
        console.error('Error loading top topics:', e);
      }
    }

    // Mark word as learned
    function markAsLearned(word, index) {
      // Get word data from API
      fetch(`/api/vocabulary/words/${index}`)
        .then(res => res.json())
        .then(wordData => {
          storage.updateWordProgress(word, wordData, 'learning');
          loadWords(currentFilters.page);
          alert(`ƒê√£ ƒë√°nh d·∫•u "${word}" l√† t·ª´ ƒë√£ h·ªçc!`);
        })
        .catch(error => {
          console.error('Error:', error);
          alert('C√≥ l·ªói x·∫£y ra');
        });
    }

    // Show word detail modal
    async function showWordDetail(word, index) {
      const modal = document.getElementById('wordModal');
      const modalWord = document.getElementById('modalWord');
      const modalContent = document.getElementById('modalContent');

      modalWord.textContent = word;
      modalContent.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-4xl text-purple-600"></i></div>';
      modal.classList.remove('hidden');

      try {
        // Get word data
        const wordRes = await fetch(`/api/vocabulary/words/${index}`);
        const wordData = await wordRes.json();

        // Get Cambridge Dictionary details (use cache first)
        let dictData = dictionaryCache[word];
        if (!dictData) {
          const dictRes = await fetch(`/api/dictionary/en/${encodeURIComponent(word)}`);
          if (dictRes.ok) {
            dictData = await dictRes.json();
            dictionaryCache[word] = dictData;
            saveDictCache();
          }
        }

        let html = `
          <div class="space-y-4">
            <div class="flex items-center space-x-4">
              <span class="level-badge level-${wordData.Level}">${wordData.Level}</span>
              <span class="text-gray-600">${wordData['Part of Speech'] || 'N/A'}</span>
              ${wordData.Topic ? `<span class="text-gray-600"><i class="fas fa-folder mr-1"></i>${wordData.Topic}</span>` : ''}
            </div>
            ${wordData.Guideword ? `<p class="text-gray-600"><strong>Guideword:</strong> ${wordData.Guideword}</p>` : ''}
            ${wordData.Translate ? `<p class="text-purple-600 font-medium"><strong>Nghƒ©a:</strong> ${wordData.Translate}</p>` : ''}
        `;

        if (dictData) {
          // Pronunciation
          if (dictData.pronunciation && dictData.pronunciation.length > 0) {
            html += `
              <div class="border-t pt-4">
                <h3 class="font-semibold mb-2">Ph√°t √¢m (IPA)</h3>
                ${dictData.pronunciation.map(pron => `
                  <div class="flex items-center space-x-2 mb-2">
                    <span class="px-2 py-1 bg-purple-50 text-purple-700 rounded text-xs font-semibold">${(pron.lang || '').toUpperCase() || 'US'}</span>
                    <span class="text-gray-800 font-mono">${pron.pron || ''}</span>
                    ${pron.url ? `<audio controls class="h-8"><source src="${pron.url}" type="audio/mpeg"></audio>` : ''}
                  </div>
                `).join('')}
              </div>
            `;
          }

          // Definitions
          if (dictData.definition && dictData.definition.length > 0) {
            html += `
              <div class="border-t pt-4">
                <h3 class="font-semibold mb-2">ƒê·ªãnh nghƒ©a</h3>
                ${dictData.definition.map(def => `
                  <div class="mb-4">
                    <p class="text-gray-700 mb-1">${def.text}</p>
                    ${def.translation ? `<p class="text-gray-600 italic">${def.translation}</p>` : ''}
                    ${def.example && def.example.length > 0 ? `
                      <div class="mt-2 ml-4 border-l-2 border-purple-200 pl-3">
                        ${def.example.map(ex => `
                          <p class="text-sm text-gray-600 mb-1">${ex.text}</p>
                          ${ex.translation ? `<p class="text-sm text-gray-500 italic">${ex.translation}</p>` : ''}
                        `).join('')}
                      </div>
                    ` : ''}
                  </div>
                `).join('')}
              </div>
            `;
          }
        } else {
          html += `<p class="text-gray-500">Kh√¥ng t√¨m th·∫•y th√¥ng tin chi ti·∫øt t·ª´ Cambridge Dictionary</p>`;
        }

        html += `</div>`;
        modalContent.innerHTML = html;
      } catch (error) {
        console.error('Error loading word detail:', error);
        modalContent.innerHTML = '<p class="text-red-500">L·ªói khi t·∫£i th√¥ng tin t·ª´</p>';
      }
    }

    // Close modal
    function closeModal() {
      document.getElementById('wordModal').classList.add('hidden');
    }

    // Close modal on outside click
    document.getElementById('wordModal').addEventListener('click', (e) => {
      if (e.target.id === 'wordModal') {
        closeModal();
      }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H·ªçc t·ª´ v·ª±ng</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <nav class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <a href="/" class="text-xl font-bold text-purple-600">üìö English Vocab</a>
        <div class="flex items-center space-x-4 text-sm">
          <a href="/learn" class="text-purple-600 font-semibold">H·ªçc t·ª´</a>
          <a href="/assessment" class="text-gray-700 hover:text-purple-600">Test Level</a>
          <a href="/ipa" class="text-gray-700 hover:text-purple-600">IPA</a>
          <a href="/combo" class="text-gray-700 hover:text-purple-600">Combo</a>
          <a href="/quiz-mix" class="text-gray-700 hover:text-purple-600">Quiz Mix</a>
          <a href="/grammar" class="text-gray-700 hover:text-purple-600">Grammar</a>
          <a href="/review" class="text-gray-700 hover:text-purple-600">√în t·ª´</a>
          <a href="/review-grammar" class="text-gray-700 hover:text-purple-600">√în Grammar</a>
        </div>
      </div>
    </div>
  </nav>
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-2xl font-bold text-gray-900 mb-4">H·ªçc T·ª´ V·ª±ng</h1>
    <p class="text-gray-600 mb-4">Trang h·ªçc t·ª´ ƒë√£ ƒë∆∞·ª£c gi·∫£n l∆∞·ª£c. B·∫°n c√≥ th·ªÉ t√≠ch h·ª£p l·∫°i API /api/vocabulary ƒë·ªÉ hi·ªÉn th·ªã danh s√°ch.</p>
    <div class="bg-white rounded-lg shadow p-4">
      <p class="text-sm text-gray-500">Placeholder. C·∫ßn l·∫•y d·ªØ li·ªáu t·ª´ /api/vocabulary v√† render.</p>
    </div>
  </main>
</body>
</html>

