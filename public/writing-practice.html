<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Luy·ªán Vi·∫øt - AI Writing Assistant</title>
  <script>
    // Suppress Tailwind CDN warning
    const originalWarn = console.warn;
    console.warn = function(...args) {
      if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com should not be used')) {
        return;
      }
      originalWarn.apply(console, args);
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://js.puter.com/v2/"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Inter', sans-serif; }

    .error-highlight {
      background: #fee2e2;
      color: #991b1b;
      padding: 2px 4px;
      border-radius: 3px;
      text-decoration: line-through;
    }

    .correction-highlight {
      background: #d1fae5;
      color: #065f46;
      padding: 2px 4px;
      border-radius: 3px;
      font-weight: 600;
    }

    .suggestion-item {
      transition: all 0.2s ease;
    }

    .suggestion-item:hover {
      transform: translateX(4px);
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @media (max-width: 640px) {
      .nav-links { gap: 8px; padding: 8px 0 6px; }
      .nav-links a { white-space: nowrap; padding: 8px 10px; border-radius: 9999px; background: #f9fafb; }
      .nav-links a.active-nav { background: #ede9fe; color: #5b21b6; font-weight: 600; }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <a href="/" class="text-xl font-bold text-purple-600">üìö English Vocab</a>
        </div>
        <div class="nav-links flex items-center space-x-2 sm:space-x-4 text-sm overflow-x-auto no-scrollbar py-2 sm:py-0" aria-label="ƒêi·ªÅu h∆∞·ªõng ch√≠nh">
          <a href="/learn" class="text-gray-600 hover:text-purple-600">H·ªçc t·ª´</a>
          <a href="/assessment" class="text-gray-600 hover:text-purple-600">Test Level</a>
          <a href="/ipa" class="text-gray-600 hover:text-purple-600">Luy·ªán IPA</a>
          <a href="/combo" class="text-gray-600 hover:text-purple-600">Combo</a>
          <a href="/quiz-mix" class="text-gray-600 hover:text-purple-600">Quiz Mix</a>
          <a href="/grammar" class="text-gray-600 hover:text-purple-600">Grammar</a>
          <a href="/writing-practice" class="text-purple-600 font-medium active-nav">Luy·ªán Vi·∫øt</a>
          <a href="/conversation-practice" class="text-gray-600 hover:text-purple-600">Luy·ªán H·ªôi tho·∫°i</a>
          <a href="/review" class="text-gray-600 hover:text-purple-600">√în t·ª´</a>
          <a href="/review-grammar" class="text-gray-600 hover:text-purple-600">√în Grammar</a>
          <a href="/voice-chat" class="text-gray-600 hover:text-purple-600">Voice Chat</a>
          <div class="border-l pl-4 ml-2 flex items-center gap-2">
            <button onclick="openPreferencesModal()" class="text-gray-600 hover:text-purple-600 flex items-center gap-1 transition-colors" title="T√πy ch·ªçn h·ªçc t·∫≠p">
              <i class="fas fa-cog"></i>
              <span class="hidden md:inline text-sm">T√πy ch·ªçn</span>
            </button>
            <button onclick="openDashboardModal()" class="text-gray-600 hover:text-purple-600 flex items-center gap-1 transition-colors" title="B·∫£ng ti·∫øn ƒë·ªô">
              <i class="fas fa-chart-line"></i>
              <span class="hidden md:inline text-sm">Ti·∫øn ƒë·ªô</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 md:py-8">
    <!-- Header -->
    <div class="mb-4 sm:mb-6 md:mb-8 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
      <div>
        <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900 mb-1 sm:mb-2">
          <i class="fas fa-pen-fancy text-purple-600 mr-2"></i>
          AI Writing Assistant
        </h1>
        <p class="text-xs sm:text-sm text-gray-600">Vi·∫øt b√†i v√† nh·∫≠n ph·∫£n h·ªìi t·ª©c th√¨ v·ªÅ ng·ªØ ph√°p, ch√≠nh t·∫£ v√† c√°ch di·ªÖn ƒë·∫°t</p>
      </div>
      <button 
        onclick="toggleHistory()"
        class="px-3 sm:px-4 py-2 sm:py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 active:bg-gray-300 transition-colors flex items-center justify-center gap-2 text-xs sm:text-sm font-medium min-h-[44px] sm:min-h-0"
      >
        <i class="fas fa-history"></i>
        <span>L·ªãch s·ª≠</span>
      </button>
    </div>

    <!-- Writing Progress Dashboard -->
    <div id="writingProgressModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-2 sm:p-4">
      <div class="bg-white rounded-lg max-w-4xl w-full max-h-[95vh] sm:max-h-[90vh] overflow-y-auto flex flex-col">
        <div class="sticky top-0 bg-white border-b p-3 sm:p-4 md:p-6 flex justify-between items-center z-10">
          <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-900">
            <i class="fas fa-chart-line text-purple-600 mr-2"></i>
            Ti·∫øn ƒë·ªô Luy·ªán Vi·∫øt
          </h2>
          <button onclick="toggleWritingProgress()" class="text-gray-500 hover:text-gray-700 p-1 sm:p-2">
            <i class="fas fa-times text-xl sm:text-2xl"></i>
          </button>
        </div>
        <div class="p-3 sm:p-4 md:p-6 flex-1 overflow-y-auto">
          <div id="writingProgressContent">
            <!-- Progress content will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Writing History Sidebar -->
    <div id="historySidebar" class="hidden fixed inset-y-0 right-0 w-full sm:w-96 bg-white shadow-xl z-50 overflow-y-auto">
      <div class="p-3 sm:p-4 md:p-6">
        <div class="flex justify-between items-center mb-3 sm:mb-4">
          <h2 class="text-lg sm:text-xl font-bold text-gray-900">L·ªãch s·ª≠ B√†i vi·∫øt</h2>
          <button onclick="toggleHistory()" class="text-gray-500 hover:text-gray-700 p-1 sm:p-2">
            <i class="fas fa-times text-xl sm:text-2xl"></i>
          </button>
        </div>
        <div id="historyList" class="space-y-3">
          <!-- History items will be displayed here -->
        </div>
        <button 
          onclick="clearHistory()"
          class="mt-4 w-full px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm"
        >
          <i class="fas fa-trash mr-2"></i>
          X√≥a t·∫•t c·∫£ l·ªãch s·ª≠
        </button>
      </div>
    </div>
    <div id="historyOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40" onclick="toggleHistory()"></div>

    <!-- Topic Selector (Phase 2) - Enhanced v·ªõi nhi·ªÅu ch·ªß ƒë·ªÅ th·ª±c t·∫ø -->
    <div class="bg-white rounded-lg shadow-lg p-3 sm:p-4 md:p-6 mb-4 sm:mb-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3 sm:mb-4">
        <div>
          <h3 class="text-lg font-semibold text-gray-900">
            <i class="fas fa-book-open text-purple-600 mr-2"></i>
            Luy·ªán t·∫≠p theo Ch·ªß ƒë·ªÅ
          </h3>
          <p class="text-sm text-gray-500 mt-1">Ch·ªçn ch·ªß ƒë·ªÅ giao ti·∫øp th·ª±c t·∫ø ƒë·ªÉ luy·ªán vi·∫øt</p>
        </div>
        <button 
          onclick="generateTopicPrompt()"
          id="generatePromptBtn"
          class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <i class="fas fa-magic"></i>
          <span>T·∫°o ƒë·ªÅ b√†i</span>
        </button>
      </div>

      <!-- Topic Categories -->
      <div class="space-y-4">
        <!-- Giao ti·∫øp H√†ng ng√†y -->
        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
            <i class="fas fa-comments text-blue-600"></i>
            Giao ti·∫øp H√†ng ng√†y
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
            <button onclick="selectTopic('greetings', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-xs text-center">
              <i class="fas fa-hand-paper mr-1"></i>Ch√†o h·ªèi
            </button>
            <button onclick="selectTopic('introductions', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-xs text-center">
              <i class="fas fa-user-plus mr-1"></i>Gi·ªõi thi·ªáu
            </button>
            <button onclick="selectTopic('small-talk', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-xs text-center">
              <i class="fas fa-comment-dots mr-1"></i>Tr√≤ chuy·ªán
            </button>
            <button onclick="selectTopic('asking-directions', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-xs text-center">
              <i class="fas fa-map-signs mr-1"></i>H·ªèi ƒë∆∞·ªùng
            </button>
            <button onclick="selectTopic('shopping', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-xs text-center">
              <i class="fas fa-shopping-cart mr-1"></i>Mua s·∫Øm
            </button>
            <button onclick="selectTopic('restaurant', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-xs text-center">
              <i class="fas fa-utensils mr-1"></i>Nh√† h√†ng
            </button>
          </div>
        </div>

        <!-- T√¨nh hu·ªëng Th·ª±c t·∫ø -->
        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
            <i class="fas fa-life-ring text-green-600"></i>
            T√¨nh hu·ªëng Th·ª±c t·∫ø
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
            <button onclick="selectTopic('making-appointments', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors text-xs text-center">
              <i class="fas fa-calendar-check mr-1"></i>ƒê·∫∑t l·ªãch
            </button>
            <button onclick="selectTopic('complaints', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors text-xs text-center">
              <i class="fas fa-exclamation-triangle mr-1"></i>Khi·∫øu n·∫°i
            </button>
            <button onclick="selectTopic('apologies', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors text-xs text-center">
              <i class="fas fa-hand-holding-heart mr-1"></i>Xin l·ªói
            </button>
            <button onclick="selectTopic('requests', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors text-xs text-center">
              <i class="fas fa-hands-helping mr-1"></i>Y√™u c·∫ßu
            </button>
            <button onclick="selectTopic('giving-advice', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors text-xs text-center">
              <i class="fas fa-lightbulb mr-1"></i>ƒê∆∞a l·ªùi khuy√™n
            </button>
            <button onclick="selectTopic('making-decisions', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors text-xs text-center">
              <i class="fas fa-check-circle mr-1"></i>Quy·∫øt ƒë·ªãnh
            </button>
          </div>
        </div>

        <!-- C√¥ng vi·ªác & H·ªçc t·∫≠p -->
        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
            <i class="fas fa-briefcase text-purple-600"></i>
            C√¥ng vi·ªác & H·ªçc t·∫≠p
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
            <button onclick="selectTopic('job-interview', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-xs text-center">
              <i class="fas fa-user-tie mr-1"></i>Ph·ªèng v·∫•n
            </button>
            <button onclick="selectTopic('workplace', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-xs text-center">
              <i class="fas fa-building mr-1"></i>N∆°i l√†m vi·ªác
            </button>
            <button onclick="selectTopic('meetings', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-xs text-center">
              <i class="fas fa-users mr-1"></i>Cu·ªôc h·ªçp
            </button>
            <button onclick="selectTopic('email-writing', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-xs text-center">
              <i class="fas fa-envelope mr-1"></i>Email c√¥ng vi·ªác
            </button>
            <button onclick="selectTopic('presentations', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-xs text-center">
              <i class="fas fa-presentation mr-1"></i>Thuy·∫øt tr√¨nh
            </button>
            <button onclick="selectTopic('studying', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-xs text-center">
              <i class="fas fa-graduation-cap mr-1"></i>H·ªçc t·∫≠p
            </button>
          </div>
        </div>

        <!-- Du l·ªãch & Gi·∫£i tr√≠ -->
        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
            <i class="fas fa-plane text-orange-600"></i>
            Du l·ªãch & Gi·∫£i tr√≠
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
            <button onclick="selectTopic('travel', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-colors text-xs text-center">
              <i class="fas fa-plane mr-1"></i>Du l·ªãch
            </button>
            <button onclick="selectTopic('hotel', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-colors text-xs text-center">
              <i class="fas fa-hotel mr-1"></i>Kh√°ch s·∫°n
            </button>
            <button onclick="selectTopic('transportation', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-colors text-xs text-center">
              <i class="fas fa-bus mr-1"></i>Giao th√¥ng
            </button>
            <button onclick="selectTopic('sightseeing', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-colors text-xs text-center">
              <i class="fas fa-camera mr-1"></i>Tham quan
            </button>
            <button onclick="selectTopic('entertainment', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-colors text-xs text-center">
              <i class="fas fa-film mr-1"></i>Gi·∫£i tr√≠
            </button>
            <button onclick="selectTopic('sports', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-colors text-xs text-center">
              <i class="fas fa-football-ball mr-1"></i>Th·ªÉ thao
            </button>
          </div>
        </div>

        <!-- S·ª©c kh·ªèe & Cu·ªôc s·ªëng -->
        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
            <i class="fas fa-heartbeat text-red-600"></i>
            S·ª©c kh·ªèe & Cu·ªôc s·ªëng
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
            <button onclick="selectTopic('health', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 transition-colors text-xs text-center">
              <i class="fas fa-heart mr-1"></i>S·ª©c kh·ªèe
            </button>
            <button onclick="selectTopic('doctor', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 transition-colors text-xs text-center">
              <i class="fas fa-user-md mr-1"></i>B√°c sƒ©
            </button>
            <button onclick="selectTopic('food', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 transition-colors text-xs text-center">
              <i class="fas fa-utensils mr-1"></i>·∫®m th·ª±c
            </button>
            <button onclick="selectTopic('exercise', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 transition-colors text-xs text-center">
              <i class="fas fa-dumbbell mr-1"></i>T·∫≠p th·ªÉ d·ª•c
            </button>
            <button onclick="selectTopic('family', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 transition-colors text-xs text-center">
              <i class="fas fa-users mr-1"></i>Gia ƒë√¨nh
            </button>
            <button onclick="selectTopic('hobbies', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-red-500 hover:bg-red-50 transition-colors text-xs text-center">
              <i class="fas fa-palette mr-1"></i>S·ªü th√≠ch
            </button>
          </div>
        </div>

        <!-- C√¥ng ngh·ªá & Hi·ªán ƒë·∫°i -->
        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
            <i class="fas fa-laptop-code text-indigo-600"></i>
            C√¥ng ngh·ªá & Hi·ªán ƒë·∫°i
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2">
            <button onclick="selectTopic('technology', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors text-xs text-center">
              <i class="fas fa-laptop mr-1"></i>C√¥ng ngh·ªá
            </button>
            <button onclick="selectTopic('social-media', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors text-xs text-center">
              <i class="fas fa-share-alt mr-1"></i>M·∫°ng x√£ h·ªôi
            </button>
            <button onclick="selectTopic('online-shopping', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors text-xs text-center">
              <i class="fas fa-shopping-bag mr-1"></i>Mua s·∫Øm online
            </button>
            <button onclick="selectTopic('banking', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors text-xs text-center">
              <i class="fas fa-university mr-1"></i>Ng√¢n h√†ng
            </button>
            <button onclick="selectTopic('customer-service', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors text-xs text-center">
              <i class="fas fa-headset mr-1"></i>ChƒÉm s√≥c KH
            </button>
            <button onclick="selectTopic('emergency', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors text-xs text-center">
              <i class="fas fa-phone-alt mr-1"></i>Kh·∫©n c·∫•p
            </button>
            <button onclick="selectTopic('digital-marketing', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors text-xs text-center">
              <i class="fas fa-bullhorn mr-1"></i>Digital Marketing
            </button>
            <button onclick="selectTopic('e-commerce', event)" class="topic-btn px-3 py-2 border-2 border-gray-200 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors text-xs text-center">
              <i class="fas fa-store mr-1"></i>E-commerce
            </button>
          </div>
        </div>
      </div>
      <div id="topicPrompt" class="mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg hidden">
        <div class="flex justify-between items-start mb-2">
          <div>
            <h4 class="font-semibold text-purple-900 mb-1">ƒê·ªÅ b√†i:</h4>
            <p id="topicPromptText" class="text-gray-800"></p>
          </div>
          <button onclick="closeTopicPrompt()" class="text-purple-600 hover:text-purple-800">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="topicVocabulary" class="mt-3">
          <!-- Vocabulary suggestions will be displayed here -->
        </div>
      </div>
    </div>

    <!-- Writing Area -->
    <div class="bg-white rounded-lg shadow-lg p-3 sm:p-4 md:p-6 mb-4 sm:mb-6">
      <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">
        <i class="fas fa-edit mr-2"></i>
        Vi·∫øt b√†i c·ªßa b·∫°n (ti·∫øng Anh)
      </label>
      <div class="relative">
        <textarea 
          id="writingInput" 
          class="w-full h-40 sm:h-48 md:h-56 px-3 sm:px-4 py-2.5 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none text-sm sm:text-base"
          placeholder="V√≠ d·ª•: I go to school yesterday. I am very happy because I learn many new things."
          spellcheck="false"
        ></textarea>
        <div id="grammarCheckOverlay" class="absolute inset-0 pointer-events-none overflow-hidden rounded-lg" style="padding: 10px 12px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; color: transparent; z-index: 1; font-size: 14px;"></div>
      </div>
      <div class="mt-3 sm:mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div class="flex items-center gap-3 sm:gap-4 text-xs sm:text-sm text-gray-500 flex-wrap">
          <div class="flex items-center gap-1">
            <i class="fas fa-font text-xs"></i>
            <span id="wordCount" class="font-semibold">0</span> t·ª´
          </div>
          <div class="flex items-center gap-1">
            <i class="fas fa-keyboard text-xs"></i>
            <span id="charCount" class="font-semibold">0</span> k√Ω t·ª±
          </div>
          <div id="autoSaveStatus" class="flex items-center gap-1 text-green-600 hidden">
            <i class="fas fa-check-circle text-xs"></i>
            <span class="text-xs">ƒê√£ l∆∞u</span>
          </div>
          <div id="autoSaveSaving" class="flex items-center gap-1 text-blue-600 hidden">
            <i class="fas fa-spinner fa-spin text-xs"></i>
            <span class="text-xs">ƒêang l∆∞u...</span>
          </div>
        </div>
        <button 
          id="correctBtn" 
          onclick="correctWriting()"
          class="w-full sm:w-auto px-4 sm:px-6 py-2.5 sm:py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 active:bg-purple-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 text-xs sm:text-sm font-medium min-h-[44px] sm:min-h-0"
        >
          <i class="fas fa-magic"></i>
          <span>S·ª≠a l·ªói v·ªõi AI</span>
        </button>
      </div>
    </div>

    <!-- AI Status -->
    <div id="aiStatus" class="hidden mb-4">
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-center gap-3">
        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
        <span class="text-blue-700">AI ƒëang x·ª≠ l√Ω...</span>
        <span id="loadingTimer" class="text-blue-600 text-sm ml-auto"></span>
      </div>
    </div>

    <!-- Results -->
    <div id="resultsContainer" class="hidden">
      <!-- Score & Level -->
      <div id="scoreContainer" class="bg-white rounded-lg shadow-lg p-3 sm:p-4 md:p-6 mb-4 sm:mb-6 hidden">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 mb-3 sm:mb-4 flex items-center gap-2">
          <i class="fas fa-star text-yellow-500"></i>
          ƒê√°nh gi√° b√†i vi·∫øt
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 text-center mb-3 sm:mb-4">
          <div class="p-3 sm:p-4 bg-blue-50 rounded-lg">
            <p class="text-2xl sm:text-3xl md:text-4xl font-bold text-blue-600" id="scoreValue">N/A</p>
            <p class="text-xs sm:text-sm text-gray-600">ƒêi·ªÉm s·ªë</p>
          </div>
          <div class="p-3 sm:p-4 bg-purple-50 rounded-lg">
            <p class="text-2xl sm:text-3xl md:text-4xl font-bold text-purple-600" id="levelValue">N/A</p>
            <p class="text-xs sm:text-sm text-gray-600">C·∫•p ƒë·ªô</p>
          </div>
          <div class="p-3 sm:p-4 bg-red-50 rounded-lg">
            <p class="text-2xl sm:text-3xl md:text-4xl font-bold text-red-600" id="errorCountBadge">N/A</p>
            <p class="text-xs sm:text-sm text-gray-600">T·ªïng l·ªói</p>
          </div>
        </div>
        <div id="errorBreakdown" class="mb-4 hidden">
          <!-- Error breakdown will be displayed here -->
        </div>
        <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
          <p class="text-sm font-semibold text-gray-700 mb-2">Ph·∫£n h·ªìi t·ª´ AI:</p>
          <p id="feedbackText" class="text-gray-800 italic">Kh√¥ng c√≥ ph·∫£n h·ªìi</p>
        </div>
      </div>

      <!-- Before/After Comparison -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
            <i class="fas fa-exchange-alt text-purple-600"></i>
            So s√°nh Tr∆∞·ªõc/Sau
          </h2>
          <div class="flex gap-2">
            <button 
              onclick="setViewMode('side-by-side')"
              id="viewSideBySide"
              class="px-3 py-1 bg-purple-600 text-white rounded text-sm"
            >
              <i class="fas fa-columns mr-1"></i> C·∫°nh nhau
            </button>
            <button 
              onclick="setViewMode('before')"
              id="viewBefore"
              class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm"
            >
              <i class="fas fa-file-alt mr-1"></i> B·∫£n g·ªëc
            </button>
            <button 
              onclick="setViewMode('after')"
              id="viewAfter"
              class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm"
            >
              <i class="fas fa-check mr-1"></i> B·∫£n s·ª≠a
            </button>
          </div>
        </div>
        <div id="comparisonView" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="border-r border-gray-200 pr-4">
            <h3 class="text-sm font-semibold text-gray-500 mb-2">B·∫£n g·ªëc</h3>
            <div id="originalText" class="prose max-w-none text-gray-800 leading-relaxed p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[200px]">
              <!-- Original text will be displayed here -->
            </div>
          </div>
          <div class="pl-4">
            <h3 class="text-sm font-semibold text-gray-500 mb-2">B·∫£n ƒë√£ s·ª≠a</h3>
            <div id="correctedText" class="prose max-w-none text-gray-800 leading-relaxed p-4 bg-green-50 rounded-lg border border-green-200 min-h-[200px]">
              <!-- Corrected text will be displayed here -->
            </div>
          </div>
        </div>
        <div class="mt-4 flex gap-2">
          <button 
            onclick="copyCorrectedText()"
            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm flex items-center gap-2"
          >
            <i class="fas fa-copy"></i>
            <span>Sao ch√©p b·∫£n ƒë√£ s·ª≠a</span>
          </button>
          <button 
            onclick="playCorrectedText()"
            id="playTTSBtn"
            class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors text-sm flex items-center gap-2"
          >
            <i class="fas fa-volume-up"></i>
            <span>Nghe b·∫£n ƒë√£ s·ª≠a</span>
          </button>
        </div>
      </div>

      <!-- Errors Found -->
      <div id="errorsContainer" class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <i class="fas fa-exclamation-triangle text-red-600"></i>
          L·ªói ƒë√£ ph√°t hi·ªán
          <span id="errorCount" class="text-sm font-normal text-gray-500"></span>
        </h2>
        <div id="errorsList" class="space-y-4">
          <!-- Errors will be displayed here -->
        </div>
      </div>

      <!-- Suggestions -->
      <div id="suggestionsContainer" class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <i class="fas fa-lightbulb text-yellow-600"></i>
          G·ª£i √Ω c·∫£i thi·ªán
        </h2>
        <div id="suggestionsList" class="space-y-2">
          <!-- Suggestions will be displayed here -->
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
      <div class="flex items-center gap-2 text-red-700">
        <i class="fas fa-exclamation-circle"></i>
        <span id="errorMessageText"></span>
      </div>
    </div>
  </div>

  <script>
    // Real-time Grammar Check
    const grammarCheckOverlay = document.getElementById('grammarCheckOverlay');
    let grammarCheckTimer = null;

    // Simple grammar rules for real-time checking
    const grammarRules = [
      {
        pattern: /\s{2,}/g, // Double spaces
        type: 'warning',
        message: 'Nhi·ªÅu kho·∫£ng tr·∫Øng li√™n ti·∫øp'
      },
      {
        pattern: /([.!?])\s*([a-z])/g, // Missing capital after sentence end
        type: 'error',
        message: 'Thi·∫øu ch·ªØ hoa sau d·∫•u c√¢u'
      },
      {
        pattern: /\b(i)\b/g, // Lowercase 'i' (should be 'I')
        type: 'error',
        message: "'i' n√™n vi·∫øt hoa th√†nh 'I'"
      },
      {
        pattern: /\b(very\s+very|really\s+really)\b/gi, // Very very, really really
        type: 'warning',
        message: 'Tr√°nh l·∫∑p t·ª´ "very" ho·∫∑c "really"'
      },
      {
        pattern: /([a-z])([A-Z])/g, // Missing space between words
        type: 'error',
        message: 'Thi·∫øu kho·∫£ng tr·∫Øng gi·ªØa c√°c t·ª´'
      },
      {
        pattern: /([a-z])([.!?])([a-z])/g, // Missing space after punctuation
        type: 'error',
        message: 'Thi·∫øu kho·∫£ng tr·∫Øng sau d·∫•u c√¢u'
      }
    ];

    function performGrammarCheck(text) {
      if (!text || text.trim().length === 0) {
        if (grammarCheckOverlay) {
          grammarCheckOverlay.textContent = '';
        }
        return;
      }

      // Create a copy of text with highlights
      const errors = [];

      // Apply grammar rules
      grammarRules.forEach((rule) => {
        const matches = [...text.matchAll(rule.pattern)];
        matches.forEach(match => {
          const start = match.index;
          const end = start + match[0].length;
          errors.push({
            start,
            end,
            type: rule.type,
            message: rule.message,
            text: match[0]
          });
        });
      });

      // Sort errors by position
      errors.sort((a, b) => a.start - b.start);

      // Build highlighted HTML
      let html = '';
      let lastIndex = 0;

      errors.forEach(error => {
        // Add text before error
        if (error.start > lastIndex) {
          html += escapeHtml(text.substring(lastIndex, error.start));
        }

        // Add highlighted error
        const errorClass = `grammar-${error.type}`;
        const errorText = escapeHtml(text.substring(error.start, error.end));
        html += `<span class="${errorClass}" title="${escapeHtml(error.message)}">${errorText}</span>`;

        lastIndex = error.end;
      });

      // Add remaining text
      if (lastIndex < text.length) {
        html += escapeHtml(text.substring(lastIndex));
      }

      if (grammarCheckOverlay) {
        grammarCheckOverlay.innerHTML = html || escapeHtml(text);
      }
    }

    // Auto-save draft key
    const DRAFT_KEY = 'writing_practice_draft';
    const AUTO_SAVE_INTERVAL = 30000; // 30 seconds
    let autoSaveTimer = null;
    let lastSavedText = '';

    // Word count function
    function countWords(text) {
      if (!text || !text.trim()) return 0;
      return text.trim().split(/\s+/).filter(word => word.length > 0).length;
    }

    // Update counters (word count + char count)
    function updateCounters() {
      const text = document.getElementById('writingInput').value;
      const charCount = text.length;
      const wordCount = countWords(text);
      
      const charCountEl = document.getElementById('charCount');
      const wordCountEl = document.getElementById('wordCount');
      const correctBtn = document.getElementById('correctBtn');
      
      if (charCountEl) charCountEl.textContent = charCount;
      if (wordCountEl) wordCountEl.textContent = wordCount;
      if (correctBtn) correctBtn.disabled = charCount === 0;
    }

    // Auto-save function
    function autoSaveDraft() {
      const text = document.getElementById('writingInput').value;
      
      // Only save if text has changed
      if (text === lastSavedText) return;
      
      // Show saving indicator
      const savingEl = document.getElementById('autoSaveSaving');
      const savedEl = document.getElementById('autoSaveStatus');
      if (savingEl) savingEl.classList.remove('hidden');
      if (savedEl) savedEl.classList.add('hidden');
      
      try {
        const draft = {
          text: text,
          timestamp: new Date().toISOString(),
          wordCount: countWords(text),
          charCount: text.length
        };
        localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
        lastSavedText = text;
        
        // Show saved indicator
        setTimeout(() => {
          if (savingEl) savingEl.classList.add('hidden');
          if (savedEl) savedEl.classList.remove('hidden');
          
          // Hide saved indicator after 2 seconds
          setTimeout(() => {
            if (savedEl) savedEl.classList.add('hidden');
          }, 2000);
        }, 300);
      } catch (e) {
        console.warn('Failed to auto-save draft:', e);
        if (savingEl) savingEl.classList.add('hidden');
      }
    }

    // Load draft on page load
    function loadDraft() {
      try {
        const draftJson = localStorage.getItem(DRAFT_KEY);
        if (draftJson) {
          const draft = JSON.parse(draftJson);
          if (draft.text && draft.text.trim()) {
            const writingInput = document.getElementById('writingInput');
            if (writingInput) {
              writingInput.value = draft.text;
              lastSavedText = draft.text;
              updateCounters();
              
              // Show notification that draft was loaded
              const savedEl = document.getElementById('autoSaveStatus');
              if (savedEl) {
                savedEl.innerHTML = '<i class="fas fa-file-alt text-xs"></i><span class="text-xs">ƒê√£ t·∫£i b·∫£n nh√°p</span>';
                savedEl.classList.remove('hidden');
                setTimeout(() => {
                  savedEl.classList.add('hidden');
                  savedEl.innerHTML = '<i class="fas fa-check-circle text-xs"></i><span class="text-xs">ƒê√£ l∆∞u</span>';
                }, 3000);
              }
            }
          }
        }
      } catch (e) {
        console.warn('Failed to load draft:', e);
      }
    }

    // Setup input listener with auto-save and grammar check
    const writingInput = document.getElementById('writingInput');
    
    if (writingInput) {
      writingInput.addEventListener('input', function() {
        updateCounters();
        
        // Real-time grammar check (debounced)
        if (grammarCheckTimer) {
          clearTimeout(grammarCheckTimer);
        }
        grammarCheckTimer = setTimeout(() => {
          performGrammarCheck(this.value);
        }, 300); // Check after 300ms of no typing
        
        // Clear existing timer
        if (autoSaveTimer) {
          clearTimeout(autoSaveTimer);
        }
        
        // Set new timer for auto-save (debounce 2 seconds after user stops typing)
        autoSaveTimer = setTimeout(() => {
          autoSaveDraft();
        }, 2000);
      });

      // Sync scroll between textarea and overlay
      if (grammarCheckOverlay) {
        writingInput.addEventListener('scroll', () => {
          grammarCheckOverlay.scrollTop = writingInput.scrollTop;
          grammarCheckOverlay.scrollLeft = writingInput.scrollLeft;
        });
      }
    }

    // Also auto-save on interval (every 30 seconds)
    setInterval(() => {
      const text = document.getElementById('writingInput')?.value || '';
      if (text && text.trim() && text !== lastSavedText) {
        autoSaveDraft();
      }
    }, AUTO_SAVE_INTERVAL);

    // Save before page unload
    window.addEventListener('beforeunload', () => {
      autoSaveDraft();
    });

    // Load draft on page load
    loadDraft();

    // Ki·ªÉm tra Puter.js availability
    function checkPuterAvailable() {
      if (typeof Puter !== 'undefined' && Puter.ai && Puter.ai.chat) {
        return Puter;
      }
      if (typeof puter !== 'undefined' && puter.ai && puter.ai.chat) {
        return puter;
      }
      if (typeof window.puter !== 'undefined' && window.puter.ai && window.puter.ai.chat) {
        return window.puter;
      }
      return null;
    }

    // Cache cho AI responses
    const writingCache = new Map();
    const CACHE_KEY = 'writing_ai_cache';

    function loadCache() {
      try {
        const cached = localStorage.getItem(CACHE_KEY);
        if (cached) {
          const cacheObj = JSON.parse(cached);
          Object.entries(cacheObj).forEach(([key, value]) => {
            writingCache.set(key, value);
          });
        }
      } catch (e) {
        console.warn('Failed to load writing cache:', e);
      }
    }

    function saveCache() {
      try {
        const cacheObj = Object.fromEntries(writingCache);
        localStorage.setItem(CACHE_KEY, JSON.stringify(cacheObj));
      } catch (e) {
        console.warn('Failed to save writing cache:', e);
      }
    }

    loadCache();

    // Main function: Correct writing with AI
    async function correctWriting() {
      const inputText = document.getElementById('writingInput').value.trim();
      
      if (!inputText) {
        showError('Vui l√≤ng nh·∫≠p b√†i vi·∫øt c·ªßa b·∫°n');
        return;
      }

      // Clear draft after successful correction (optional - user might want to keep it)
      // Uncomment if you want to clear draft after correction:
      // localStorage.removeItem(DRAFT_KEY);
      // lastSavedText = '';

      // Check cache first
      const cacheKey = inputText.toLowerCase().trim();
      if (writingCache.has(cacheKey)) {
        console.log('‚úÖ Using cached result');
        await displayResultsEnhanced(writingCache.get(cacheKey));
        return;
      }

      // Check Puter.js availability
      const puterClient = checkPuterAvailable();
      if (!puterClient) {
        showError('Puter.js kh√¥ng kh·∫£ d·ª•ng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi ho·∫∑c ƒëƒÉng nh·∫≠p Puter.com');
        return;
      }

      // Show loading
      showLoading(true);
      hideError();
      hideResults();

      const startTime = Date.now();
      let loadingTimer = 0;
      const timerInterval = setInterval(() => {
        loadingTimer += 1;
        document.getElementById('loadingTimer').textContent = `${loadingTimer}s`;
      }, 1000);

      try {
        const prompt = `B·∫°n l√† gi√°o vi√™n s·ª≠a b√†i vi·∫øt ti·∫øng Anh chuy√™n nghi·ªáp. H√£y ph√¢n t√≠ch v√† s·ª≠a b√†i vi·∫øt sau:

B√†i vi·∫øt c·ªßa h·ªçc sinh:
"${inputText}"

Y√™u c·∫ßu:
1. S·ª≠a t·∫•t c·∫£ l·ªói ng·ªØ ph√°p, ch√≠nh t·∫£, d·∫•u c√¢u
2. C·∫£i thi·ªán c√°ch di·ªÖn ƒë·∫°t n·∫øu c·∫ßn
3. Li·ªát k√™ c√°c l·ªói ƒë√£ s·ª≠a v·ªõi gi·∫£i th√≠ch chi ti·∫øt
4. Ph√¢n lo·∫°i t·ª´ng l·ªói: "grammar" (ng·ªØ ph√°p), "spelling" (ch√≠nh t·∫£), "expression" (di·ªÖn ƒë·∫°t), "punctuation" (d·∫•u c√¢u)
5. ƒê∆∞a ra g·ª£i √Ω c·∫£i thi·ªán
6. ƒê√°nh gi√° b√†i vi·∫øt v·ªõi ƒëi·ªÉm s·ªë t·ª´ 0-100
7. ƒê√°nh gi√° c·∫•p ƒë·ªô ti·∫øng Anh (A1, A2, B1, B2, C1, C2)
8. ƒê∆∞a ra ph·∫£n h·ªìi t·ªïng quan v·ªÅ b√†i vi·∫øt

Tr·∫£ v·ªÅ JSON format ch√≠nh x√°c (kh√¥ng markdown, ch·ªâ JSON):
{
  "corrected": "B·∫£n ƒë√£ s·ª≠a ho√†n ch·ªânh",
  "errors": [
    {
      "original": "T·ª´/c√¢u sai",
      "corrected": "T·ª´/c√¢u ƒë√∫ng",
      "explanation": "Gi·∫£i th√≠ch l·ªói chi ti·∫øt",
      "type": "grammar"
    }
  ],
  "suggestions": ["G·ª£i √Ω 1", "G·ª£i √Ω 2"],
  "score": 85,
  "level": "B1",
  "errorBreakdown": {
    "grammar": 3,
    "spelling": 1,
    "expression": 2,
    "punctuation": 0
  },
  "feedback": "B√†i vi·∫øt t·ªët, c·∫ßn c·∫£i thi·ªán ng·ªØ ph√°p. B·∫°n ƒë√£ s·ª≠ d·ª•ng t·ª´ v·ª±ng phong ph√∫ nh∆∞ng c√≤n m·ªôt s·ªë l·ªói v·ªÅ th√¨ ƒë·ªông t·ª´..."
}`;

        const modelsToTry = ["gpt-4o-mini", "gpt-3.5-turbo", "gpt-5-mini", "gpt-5-nano", "gpt-4o"];
        let response = null;

        for (const model of modelsToTry) {
          try {
            try {
              response = await puterClient.ai.chat(prompt, {
                model: model,
                max_tokens: 500
              });
              console.log(`‚úÖ Success with model: ${model}`);
              break;
            } catch (optionsError) {
              // N·∫øu l·ªói v·ªÅ options, th·ª≠ kh√¥ng c√≥ options
              if (optionsError && typeof optionsError === 'object') {
                const errorMsg = optionsError.error?.message || optionsError.error?.code || optionsError.message || '';
                if (errorMsg.includes('temperature') || errorMsg.includes('max_tokens')) {
                  console.log(`‚ö†Ô∏è Options not supported for ${model}, trying without options...`);
                  response = await puterClient.ai.chat(prompt, { model: model });
                  console.log(`‚úÖ Success with model: ${model} (no options)`);
                  break;
                }
              }
              throw optionsError;
            }
          } catch (modelError) {
            if (modelError && typeof modelError === 'object') {
              const errorMsg = modelError.error?.message || modelError.error?.code || modelError.message || '';
              if (errorMsg.includes('model') && (errorMsg.includes('not found') || errorMsg.includes('not available'))) {
                console.log(`‚ö†Ô∏è Model ${model} not available, trying next...`);
                continue;
              }
            }
            if (model === modelsToTry[modelsToTry.length - 1]) {
              throw modelError;
            }
            continue;
          }
        }

        if (!response) {
          throw new Error('T·∫•t c·∫£ AI models ƒë·ªÅu kh√¥ng kh·∫£ d·ª•ng');
        }

        // Extract response text
        let responseText = '';
        if (typeof response === 'string') {
          responseText = response;
        } else if (response && typeof response === 'object') {
          if (response.message && response.message.content) {
            responseText = response.message.content;
          } else if (response.choices && response.choices[0] && response.choices[0].message && response.choices[0].message.content) {
            responseText = response.choices[0].message.content;
          } else {
            responseText = response.text || response.content || response.message || '';
          }
        }

        if (!responseText) {
          throw new Error('AI kh√¥ng tr·∫£ v·ªÅ ph·∫£n h·ªìi');
        }

        // Parse JSON (remove markdown code blocks if any)
        let jsonText = responseText.trim();
        if (jsonText.startsWith('```json')) {
          jsonText = jsonText.replace(/^```json\s*/, '').replace(/\s*```$/, '');
        } else if (jsonText.startsWith('```')) {
          jsonText = jsonText.replace(/^```\s*/, '').replace(/\s*```$/, '');
        }

        const result = JSON.parse(jsonText);

        // Validate result structure
        if (!result.corrected) {
          throw new Error('AI response kh√¥ng ƒë√∫ng format');
        }

        // Cache result
        writingCache.set(cacheKey, result);
        saveCache();

        const duration = Date.now() - startTime;
        console.log(`‚úÖ AI response time: ${duration}ms (${(duration / 1000).toFixed(1)}s)`);

        // Update writing progress
        updateWritingProgress(result);

        // Display results
        displayResults(result);

      } catch (error) {
        console.error('Writing correction error:', error);
        showError(`L·ªói khi s·ª≠a b√†i vi·∫øt: ${error.message || 'Vui l√≤ng th·ª≠ l·∫°i'}`);
      } finally {
        clearInterval(timerInterval);
        showLoading(false);
      }
    }

    // Writing History
    const WRITING_HISTORY_KEY = 'writing_history';
    let writingHistory = [];

    function loadHistory() {
      try {
        const saved = localStorage.getItem(WRITING_HISTORY_KEY);
        if (saved) {
          writingHistory = JSON.parse(saved);
        }
      } catch (e) {
        console.warn('Failed to load writing history:', e);
        writingHistory = [];
      }
    }

    function saveHistory() {
      try {
        localStorage.setItem(WRITING_HISTORY_KEY, JSON.stringify(writingHistory));
      } catch (e) {
        console.warn('Failed to save writing history:', e);
      }
    }

    function addToHistory(original, result) {
      const historyItem = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        original: original,
        corrected: result.corrected,
        score: result.score || 0,
        level: result.level || 'N/A',
        errorCount: result.errors?.length || 0,
        result: result
      };
      writingHistory.unshift(historyItem); // Add to beginning
      // Keep only last 50 items
      if (writingHistory.length > 50) {
        writingHistory = writingHistory.slice(0, 50);
      }
      saveHistory();
      renderHistory();
    }

    function renderHistory() {
      const historyListEl = document.getElementById('historyList');
      if (!historyListEl) return;

      if (writingHistory.length === 0) {
        historyListEl.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ l·ªãch s·ª≠ b√†i vi·∫øt</p>';
        return;
      }

      historyListEl.innerHTML = writingHistory.map(item => {
        const date = new Date(item.timestamp);
        const dateStr = date.toLocaleDateString('vi-VN', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        const preview = item.original.length > 100 
          ? item.original.substring(0, 100) + '...' 
          : item.original;

        return `
          <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition-colors" onclick="loadHistoryItem(${item.id})">
            <div class="flex justify-between items-start mb-2">
              <div class="flex-1">
                <p class="text-sm text-gray-600 mb-1">${dateStr}</p>
                <p class="text-gray-800 text-sm">${escapeHtml(preview)}</p>
              </div>
              <div class="text-right ml-4">
                <div class="text-lg font-bold text-purple-600">${item.score || 0}</div>
                <div class="text-xs text-gray-500">${item.level || 'N/A'}</div>
              </div>
            </div>
            <div class="flex gap-2 mt-2">
              <span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded">${item.errorCount} l·ªói</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function loadHistoryItem(id) {
      const item = writingHistory.find(h => h.id === id);
      if (!item) return;

      // Load v√†o input v√† display results
      document.getElementById('writingInput').value = item.original;
      document.getElementById('charCount').textContent = item.original.length;
      displayResultsEnhanced(item.result);
      toggleHistory(); // Close sidebar
    }

    function toggleHistory() {
      const sidebar = document.getElementById('historySidebar');
      const overlay = document.getElementById('historyOverlay');
      sidebar.classList.toggle('hidden');
      overlay.classList.toggle('hidden');
    }

    // Writing Progress Dashboard
    const WRITING_PROGRESS_KEY = 'writing_progress_stats';

    function getWritingProgress() {
      try {
        const saved = localStorage.getItem(WRITING_PROGRESS_KEY);
        if (saved) {
          return JSON.parse(saved);
        }
      } catch (e) {
        console.warn('Failed to load writing progress:', e);
      }
      return {
        totalWritings: 0,
        totalErrors: 0,
        averageScore: 0,
        currentLevel: 'A1',
        streak: 0,
        lastWritingDate: null,
        errorBreakdown: {
          grammar: 0,
          spelling: 0,
          expression: 0,
          punctuation: 0
        },
        dailyStats: {},
        levelProgression: []
      };
    }

    function saveWritingProgress(progress) {
      try {
        localStorage.setItem(WRITING_PROGRESS_KEY, JSON.stringify(progress));
      } catch (e) {
        console.warn('Failed to save writing progress:', e);
      }
    }

    function updateWritingProgress(result) {
      const progress = getWritingProgress();
      const today = new Date().toISOString().split('T')[0];
      
      // Update totals
      progress.totalWritings += 1;
      progress.totalErrors += result.errors?.length || 0;
      
      // Update average score
      const currentAvg = progress.averageScore;
      const newScore = result.score || 0;
      progress.averageScore = Math.round(
        (currentAvg * (progress.totalWritings - 1) + newScore) / progress.totalWritings
      );
      
      // Update level
      if (result.level) {
        progress.currentLevel = result.level;
        if (!progress.levelProgression.find(l => l.level === result.level)) {
          progress.levelProgression.push({
            level: result.level,
            date: today,
            score: newScore
          });
        }
      }
      
      // Update error breakdown
      if (result.errorBreakdown) {
        Object.keys(result.errorBreakdown).forEach(key => {
          progress.errorBreakdown[key] = (progress.errorBreakdown[key] || 0) + 
                                         (result.errorBreakdown[key] || 0);
        });
      }
      
      // Update streak
      const lastDate = progress.lastWritingDate;
      if (lastDate === today) {
        // Already wrote today, no change
      } else if (lastDate) {
        const lastDateObj = new Date(lastDate);
        const todayObj = new Date(today);
        const daysDiff = Math.floor((todayObj - lastDateObj) / (1000 * 60 * 60 * 24));
        if (daysDiff === 1) {
          progress.streak += 1;
        } else {
          progress.streak = 1;
        }
      } else {
        progress.streak = 1;
      }
      progress.lastWritingDate = today;
      
      // Update daily stats
      if (!progress.dailyStats[today]) {
        progress.dailyStats[today] = {
          writings: 0,
          errors: 0,
          averageScore: 0,
          scores: []
        };
      }
      const daily = progress.dailyStats[today];
      daily.writings += 1;
      daily.errors += result.errors?.length || 0;
      daily.scores.push(newScore);
      daily.averageScore = Math.round(
        daily.scores.reduce((a, b) => a + b, 0) / daily.scores.length
      );
      
      saveWritingProgress(progress);
      return progress;
    }

    function renderWritingProgress() {
      const progress = getWritingProgress();
      const content = document.getElementById('writingProgressContent');
      if (!content) return;

      // Get last 7 days stats
      const last7Days = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const dayStats = progress.dailyStats[dateStr] || {
          writings: 0,
          errors: 0,
          averageScore: 0
        };
        last7Days.push({
          date: dateStr,
          dayName: date.toLocaleDateString('vi-VN', { weekday: 'short' }),
          ...dayStats
        });
      }

      const maxErrors = Math.max(...last7Days.map(d => d.errors), 1);
      const maxWritings = Math.max(...last7Days.map(d => d.writings), 1);

      content.innerHTML = `
        <!-- Overall Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-blue-50 p-4 rounded-lg text-center">
            <div class="text-3xl font-bold text-blue-600">${progress.totalWritings}</div>
            <div class="text-sm text-gray-600 mt-1">T·ªïng b√†i vi·∫øt</div>
          </div>
          <div class="bg-purple-50 p-4 rounded-lg text-center">
            <div class="text-3xl font-bold text-purple-600">${progress.streak}</div>
            <div class="text-sm text-gray-600 mt-1">Ng√†y li√™n ti·∫øp</div>
          </div>
          <div class="bg-green-50 p-4 rounded-lg text-center">
            <div class="text-3xl font-bold text-green-600">${progress.averageScore}</div>
            <div class="text-sm text-gray-600 mt-1">ƒêi·ªÉm trung b√¨nh</div>
          </div>
          <div class="bg-orange-50 p-4 rounded-lg text-center">
            <div class="text-3xl font-bold text-orange-600">${progress.currentLevel}</div>
            <div class="text-sm text-gray-600 mt-1">C·∫•p ƒë·ªô hi·ªán t·∫°i</div>
          </div>
        </div>

        <!-- Error Breakdown -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4">Ph√¢n t√≠ch L·ªói</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center p-3 bg-orange-50 rounded">
              <div class="text-2xl font-bold text-orange-600">${progress.errorBreakdown.grammar || 0}</div>
              <div class="text-xs text-gray-600">Ng·ªØ ph√°p</div>
            </div>
            <div class="text-center p-3 bg-red-50 rounded">
              <div class="text-2xl font-bold text-red-600">${progress.errorBreakdown.spelling || 0}</div>
              <div class="text-xs text-gray-600">Ch√≠nh t·∫£</div>
            </div>
            <div class="text-center p-3 bg-blue-50 rounded">
              <div class="text-2xl font-bold text-blue-600">${progress.errorBreakdown.expression || 0}</div>
              <div class="text-xs text-gray-600">Di·ªÖn ƒë·∫°t</div>
            </div>
            <div class="text-center p-3 bg-purple-50 rounded">
              <div class="text-2xl font-bold text-purple-600">${progress.errorBreakdown.punctuation || 0}</div>
              <div class="text-xs text-gray-600">D·∫•u c√¢u</div>
            </div>
          </div>
        </div>

        <!-- Last 7 Days Chart -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
          <h3 class="text-lg font-bold text-gray-900 mb-4">7 Ng√†y G·∫ßn ƒê√¢y</h3>
          <div class="space-y-4">
            ${last7Days.map(day => `
              <div>
                <div class="flex justify-between items-center mb-1">
                  <span class="text-sm font-medium text-gray-700">${day.dayName}</span>
                  <span class="text-xs text-gray-500">${day.writings} b√†i, ${day.errors} l·ªói</span>
                </div>
                <div class="flex gap-2">
                  <div class="flex-1 bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div class="bg-red-500 h-full" style="width: ${(day.errors / maxErrors) * 100}%"></div>
                  </div>
                  <div class="text-xs text-gray-600 w-12 text-right">${day.averageScore || 0}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>

        <!-- Level Progression -->
        ${progress.levelProgression.length > 0 ? `
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Ti·∫øn tr√¨nh C·∫•p ƒë·ªô</h3>
            <div class="space-y-2">
              ${progress.levelProgression.map(lp => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                  <span class="font-semibold text-purple-600">${lp.level}</span>
                  <span class="text-sm text-gray-600">${new Date(lp.date).toLocaleDateString('vi-VN')}</span>
                  <span class="text-sm text-gray-500">ƒêi·ªÉm: ${lp.score}</span>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
      `;
    }

    function toggleWritingProgress() {
      const modal = document.getElementById('writingProgressModal');
      if (modal) {
        modal.classList.toggle('hidden');
        if (!modal.classList.contains('hidden')) {
          renderWritingProgress();
        }
      }
    }

    function clearHistory() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ l·ªãch s·ª≠?')) {
        writingHistory = [];
        saveHistory();
        renderHistory();
      }
    }

    // View mode for comparison
    let currentViewMode = 'side-by-side';

    function setViewMode(mode) {
      currentViewMode = mode;
      const comparisonView = document.getElementById('comparisonView');
      const originalEl = document.getElementById('originalText');
      const correctedEl = document.getElementById('correctedText');

      // Update button states
      document.getElementById('viewSideBySide').className = 
        mode === 'side-by-side' ? 'px-3 py-1 bg-purple-600 text-white rounded text-sm' : 'px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm';
      document.getElementById('viewBefore').className = 
        mode === 'before' ? 'px-3 py-1 bg-purple-600 text-white rounded text-sm' : 'px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm';
      document.getElementById('viewAfter').className = 
        mode === 'after' ? 'px-3 py-1 bg-purple-600 text-white rounded text-sm' : 'px-3 py-1 bg-gray-200 text-gray-700 rounded text-sm';

      if (mode === 'side-by-side') {
        comparisonView.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
        originalEl.parentElement.classList.remove('hidden');
        correctedEl.parentElement.classList.remove('hidden');
      } else if (mode === 'before') {
        comparisonView.className = 'grid grid-cols-1 gap-4';
        originalEl.parentElement.classList.remove('hidden');
        correctedEl.parentElement.classList.add('hidden');
      } else if (mode === 'after') {
        comparisonView.className = 'grid grid-cols-1 gap-4';
        originalEl.parentElement.classList.add('hidden');
        correctedEl.parentElement.classList.remove('hidden');
      }
    }

    // TTS Integration
    function checkPuterTTSAvailable() {
      if (typeof Puter !== 'undefined' && Puter.ai && Puter.ai.txt2speech) {
        return Puter;
      }
      if (typeof puter !== 'undefined' && puter.ai && puter.ai.txt2speech) {
        return puter;
      }
      if (typeof window.puter !== 'undefined' && window.puter.ai && window.puter.ai.txt2speech) {
        return window.puter;
      }
      return null;
    }

    function checkWebSpeechAvailable() {
      return 'speechSynthesis' in window && 'SpeechSynthesisUtterance' in window;
    }

    async function playCorrectedText() {
      const correctedText = document.getElementById('correctedText').textContent.trim();
      if (!correctedText) {
        showError('Kh√¥ng c√≥ vƒÉn b·∫£n ƒë·ªÉ ph√°t');
        return;
      }

      const btn = document.getElementById('playTTSBtn');
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>ƒêang ph√°t...</span>';

      try {
        // Try Puter.js TTS first
        const puterClient = checkPuterTTSAvailable();
        if (puterClient) {
          const audioResult = await puterClient.ai.txt2speech(correctedText, {
            provider: 'elevenlabs',
            voice: '21m00Tcm4TlvDq8ikWAM',
            model: 'eleven_multilingual_v2'
          });

          if (audioResult && audioResult.src) {
            const audio = new Audio(audioResult.src);
            audio.play();
            audio.onended = () => {
              btn.disabled = false;
              btn.innerHTML = originalHTML;
            };
            audio.onerror = () => {
              // Fallback to Web Speech API
              playWithWebSpeech(correctedText, btn, originalHTML);
            };
            return;
          }
        }

        // Fallback to Web Speech API
        playWithWebSpeech(correctedText, btn, originalHTML);
      } catch (error) {
        console.error('TTS error:', error);
        playWithWebSpeech(correctedText, btn, originalHTML);
      }
    }

    function playWithWebSpeech(text, btn, originalHTML) {
      if (!checkWebSpeechAvailable()) {
        showError('TTS kh√¥ng kh·∫£ d·ª•ng tr√™n tr√¨nh duy·ªát n√†y');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        return;
      }

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      utterance.rate = 0.8;
      utterance.pitch = 1;
      utterance.volume = 1;

      const voices = speechSynthesis.getVoices();
      const englishVoice = voices.find(v => 
        v.lang.startsWith('en') && v.name.toLowerCase().includes('female')
      ) || voices.find(v => v.lang.startsWith('en-US')) || voices[0];

      if (englishVoice) {
        utterance.voice = englishVoice;
      }

      utterance.onend = () => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
      };

      utterance.onerror = () => {
        showError('L·ªói khi ph√°t √¢m thanh');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
      };

      speechSynthesis.speak(utterance);
    }

    function displayResults(result) {
      // Save original text
      const originalText = document.getElementById('writingInput').value.trim();
      
      // Save to history
      addToHistory(originalText, result);

      // Display score and level
      const scoreContainer = document.getElementById('scoreContainer');
      if (result.score !== undefined || result.level || result.errorBreakdown) {
        scoreContainer.classList.remove('hidden');
        document.getElementById('scoreValue').textContent = result.score !== undefined ? result.score : 'N/A';
        document.getElementById('levelValue').textContent = result.level || 'N/A';
        document.getElementById('errorCountBadge').textContent = result.errors?.length || 0;
        document.getElementById('feedbackText').textContent = result.feedback || 'Kh√¥ng c√≥ ph·∫£n h·ªìi';
        
        // Display error breakdown if available
        if (result.errorBreakdown) {
          const breakdownEl = document.getElementById('errorBreakdown');
          if (breakdownEl) {
            const breakdown = result.errorBreakdown;
            const total = (breakdown.grammar || 0) + (breakdown.spelling || 0) + 
                         (breakdown.expression || 0) + (breakdown.punctuation || 0);
            
            if (total > 0) {
              breakdownEl.classList.remove('hidden');
              breakdownEl.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2">
                  ${breakdown.grammar ? `
                    <div class="text-center p-2 bg-orange-50 rounded">
                      <div class="text-lg font-bold text-orange-600">${breakdown.grammar}</div>
                      <div class="text-xs text-gray-600">Ng·ªØ ph√°p</div>
                    </div>
                  ` : ''}
                  ${breakdown.spelling ? `
                    <div class="text-center p-2 bg-red-50 rounded">
                      <div class="text-lg font-bold text-red-600">${breakdown.spelling}</div>
                      <div class="text-xs text-gray-600">Ch√≠nh t·∫£</div>
                    </div>
                  ` : ''}
                  ${breakdown.expression ? `
                    <div class="text-center p-2 bg-blue-50 rounded">
                      <div class="text-lg font-bold text-blue-600">${breakdown.expression}</div>
                      <div class="text-xs text-gray-600">Di·ªÖn ƒë·∫°t</div>
                    </div>
                  ` : ''}
                  ${breakdown.punctuation ? `
                    <div class="text-center p-2 bg-purple-50 rounded">
                      <div class="text-lg font-bold text-purple-600">${breakdown.punctuation}</div>
                      <div class="text-xs text-gray-600">D·∫•u c√¢u</div>
                    </div>
                  ` : ''}
                </div>
              `;
            } else {
              breakdownEl.classList.add('hidden');
            }
          }
        }
      } else {
        scoreContainer.classList.add('hidden');
      }

      // Display original and corrected text for comparison
      const originalEl = document.getElementById('originalText');
      const correctedEl = document.getElementById('correctedText');
      originalEl.textContent = originalText;
      correctedEl.textContent = result.corrected || 'Kh√¥ng c√≥ b·∫£n s·ª≠a';

      // Display errors
      const errorsListEl = document.getElementById('errorsList');
      const errorsContainerEl = document.getElementById('errorsContainer');
      const errorCountEl = document.getElementById('errorCount');

      if (result.errors && result.errors.length > 0) {
        errorsContainerEl.classList.remove('hidden');
        errorCountEl.textContent = `(${result.errors.length} l·ªói)`;
        
        errorsListEl.innerHTML = result.errors.map((error, index) => `
          <div class="border-l-4 border-red-500 pl-4 py-2 bg-red-50 rounded">
            <div class="flex items-start gap-3">
              <span class="text-red-600 font-bold">${index + 1}.</span>
              <div class="flex-1">
                <div class="mb-2">
                  <span class="error-highlight">${escapeHtml(error.original || 'N/A')}</span>
                  <span class="mx-2 text-gray-400">‚Üí</span>
                  <span class="correction-highlight">${escapeHtml(error.corrected || 'N/A')}</span>
                </div>
                <p class="text-sm text-gray-600">${escapeHtml(error.explanation || 'Kh√¥ng c√≥ gi·∫£i th√≠ch')}</p>
              </div>
            </div>
          </div>
        `).join('');
      } else {
        errorsContainerEl.classList.add('hidden');
      }

      // Display suggestions
      const suggestionsListEl = document.getElementById('suggestionsList');
      const suggestionsContainerEl = document.getElementById('suggestionsContainer');

      if (result.suggestions && result.suggestions.length > 0) {
        suggestionsContainerEl.classList.remove('hidden');
        suggestionsListEl.innerHTML = result.suggestions.map((suggestion, index) => `
          <div class="suggestion-item flex items-start gap-3 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
            <span class="text-yellow-600 font-bold mt-1">${index + 1}.</span>
            <span class="text-gray-700 flex-1">${escapeHtml(suggestion)}</span>
          </div>
        `).join('');
      } else {
        suggestionsContainerEl.classList.add('hidden');
      }

      // Show results container
      document.getElementById('resultsContainer').classList.remove('hidden');
    }

    function copyCorrectedText() {
      const correctedText = document.getElementById('correctedText').textContent;
      navigator.clipboard.writeText(correctedText).then(() => {
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> <span>ƒê√£ sao ch√©p!</span>';
        btn.classList.add('bg-green-100', 'text-green-700');
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.remove('bg-green-100', 'text-green-700');
        }, 2000);
      });
    }

    function showLoading(show) {
      const statusEl = document.getElementById('aiStatus');
      if (show) {
        statusEl.classList.remove('hidden');
      } else {
        statusEl.classList.add('hidden');
      }
    }

    function hideResults() {
      document.getElementById('resultsContainer').classList.add('hidden');
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      const errorTextEl = document.getElementById('errorMessageText');
      errorTextEl.textContent = message;
      errorEl.classList.remove('hidden');
    }

    function hideError() {
      document.getElementById('errorMessage').classList.add('hidden');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============================================
    // Phase 2: Advanced Features
    // ============================================

    // 1. Topic-based Practice
    let currentTopic = null;

    function selectTopic(topic, event) {
      currentTopic = topic;
      
      // Update button styles - remove all active states
      document.querySelectorAll('.topic-btn').forEach(btn => {
        btn.classList.remove('border-purple-500', 'bg-purple-50', 'border-blue-500', 'bg-blue-50', 
                            'border-green-500', 'bg-green-50', 'border-orange-500', 'bg-orange-50',
                            'border-red-500', 'bg-red-50', 'border-indigo-500', 'bg-indigo-50');
        btn.classList.add('border-gray-200');
      });
      
      // Find clicked button
      let clickedBtn = null;
      if (event && event.target) {
        clickedBtn = event.target.closest('.topic-btn') || event.target;
      }
      
      // If not found, find by searching all buttons
      if (!clickedBtn) {
        document.querySelectorAll('.topic-btn').forEach(btn => {
          if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`selectTopic('${topic}'`)) {
            clickedBtn = btn;
          }
        });
      }
      
      if (clickedBtn) {
        // Determine color based on category
        const categoryColors = {
          'greetings': { border: 'border-blue-500', bg: 'bg-blue-50' },
          'introductions': { border: 'border-blue-500', bg: 'bg-blue-50' },
          'small-talk': { border: 'border-blue-500', bg: 'bg-blue-50' },
          'asking-directions': { border: 'border-blue-500', bg: 'bg-blue-50' },
          'shopping': { border: 'border-blue-500', bg: 'bg-blue-50' },
          'restaurant': { border: 'border-blue-500', bg: 'bg-blue-50' },
          'making-appointments': { border: 'border-green-500', bg: 'bg-green-50' },
          'complaints': { border: 'border-green-500', bg: 'bg-green-50' },
          'apologies': { border: 'border-green-500', bg: 'bg-green-50' },
          'requests': { border: 'border-green-500', bg: 'bg-green-50' },
          'giving-advice': { border: 'border-green-500', bg: 'bg-green-50' },
          'making-decisions': { border: 'border-green-500', bg: 'bg-green-50' },
          'job-interview': { border: 'border-purple-500', bg: 'bg-purple-50' },
          'workplace': { border: 'border-purple-500', bg: 'bg-purple-50' },
          'meetings': { border: 'border-purple-500', bg: 'bg-purple-50' },
          'email-writing': { border: 'border-purple-500', bg: 'bg-purple-50' },
          'presentations': { border: 'border-purple-500', bg: 'bg-purple-50' },
          'studying': { border: 'border-purple-500', bg: 'bg-purple-50' },
          'travel': { border: 'border-orange-500', bg: 'bg-orange-50' },
          'hotel': { border: 'border-orange-500', bg: 'bg-orange-50' },
          'transportation': { border: 'border-orange-500', bg: 'bg-orange-50' },
          'sightseeing': { border: 'border-orange-500', bg: 'bg-orange-50' },
          'entertainment': { border: 'border-orange-500', bg: 'bg-orange-50' },
          'sports': { border: 'border-orange-500', bg: 'bg-orange-50' },
          'health': { border: 'border-red-500', bg: 'bg-red-50' },
          'doctor': { border: 'border-red-500', bg: 'bg-red-50' },
          'food': { border: 'border-red-500', bg: 'bg-red-50' },
          'exercise': { border: 'border-red-500', bg: 'bg-red-50' },
          'family': { border: 'border-red-500', bg: 'bg-red-50' },
          'hobbies': { border: 'border-red-500', bg: 'bg-red-50' },
          'technology': { border: 'border-indigo-500', bg: 'bg-indigo-50' },
          'social-media': { border: 'border-indigo-500', bg: 'bg-indigo-50' },
          'online-shopping': { border: 'border-indigo-500', bg: 'bg-indigo-50' },
          'banking': { border: 'border-indigo-500', bg: 'bg-indigo-50' },
          'customer-service': { border: 'border-indigo-500', bg: 'bg-indigo-50' },
          'emergency': { border: 'border-indigo-500', bg: 'bg-indigo-50' }
        };
        
        const colors = categoryColors[topic] || { border: 'border-purple-500', bg: 'bg-purple-50' };
        clickedBtn.classList.remove('border-gray-200');
        clickedBtn.classList.add(colors.border, colors.bg);
      }
      
      // Enable generate button
      const generateBtn = document.getElementById('generatePromptBtn');
      if (generateBtn) {
        generateBtn.disabled = false;
      }
    }

    async function generateTopicPrompt() {
      if (!currentTopic) {
        showError('Vui l√≤ng ch·ªçn ch·ªß ƒë·ªÅ tr∆∞·ªõc');
        return;
      }

      const puterClient = checkPuterAvailable();
      if (!puterClient) {
        showError('Puter.js kh√¥ng kh·∫£ d·ª•ng');
        return;
      }

      const topicNames = {
        // Giao ti·∫øp H√†ng ng√†y
        'greetings': 'Greetings and Introductions',
        'introductions': 'Introducing Yourself and Others',
        'small-talk': 'Small Talk and Casual Conversation',
        'asking-directions': 'Asking for Directions',
        'shopping': 'Shopping and Buying Things',
        'restaurant': 'Ordering Food at Restaurant',
        // T√¨nh hu·ªëng Th·ª±c t·∫ø
        'making-appointments': 'Making Appointments and Reservations',
        'complaints': 'Making Complaints',
        'apologies': 'Apologizing and Making Excuses',
        'requests': 'Making Requests and Asking for Help',
        'giving-advice': 'Giving Advice and Suggestions',
        'making-decisions': 'Making Decisions and Choices',
        // C√¥ng vi·ªác & H·ªçc t·∫≠p
        'job-interview': 'Job Interview',
        'workplace': 'Workplace Communication',
        'meetings': 'Business Meetings',
        'email-writing': 'Writing Professional Emails',
        'presentations': 'Giving Presentations',
        'studying': 'Studying and Education',
        // Du l·ªãch & Gi·∫£i tr√≠
        'travel': 'Travel and Tourism',
        'hotel': 'Hotel Booking and Check-in',
        'transportation': 'Transportation and Getting Around',
        'sightseeing': 'Sightseeing and Tourist Activities',
        'entertainment': 'Entertainment and Leisure',
        'sports': 'Sports and Fitness',
        // S·ª©c kh·ªèe & Cu·ªôc s·ªëng
        'health': 'Health and Wellness',
        'doctor': 'Visiting the Doctor',
        'food': 'Food and Cooking',
        'exercise': 'Exercise and Fitness',
        'family': 'Family and Relationships',
        'hobbies': 'Hobbies and Interests',
        // C√¥ng ngh·ªá & Hi·ªán ƒë·∫°i
        'technology': 'Technology and Gadgets',
        'social-media': 'Social Media and Online Communication',
        'online-shopping': 'Online Shopping',
        'banking': 'Banking and Finance',
        'customer-service': 'Customer Service',
        'emergency': 'Emergency Situations',
        'digital-marketing': 'Digital Marketing',
        'e-commerce': 'E-commerce'
      };

      showLoading(true);
      try {
        const prompt = `T·∫°o m·ªôt ƒë·ªÅ b√†i vi·∫øt ti·∫øng Anh v·ªÅ ch·ªß ƒë·ªÅ "${topicNames[currentTopic]}". 
Y√™u c·∫ßu:
1. ƒê·ªÅ b√†i ng·∫Øn g·ªçn, r√µ r√†ng (1-2 c√¢u)
2. Ph√π h·ª£p v·ªõi level B1-B2
3. G·ª£i √Ω 5-7 t·ª´ v·ª±ng li√™n quan (k√®m nghƒ©a ti·∫øng Vi·ªát)

Tr·∫£ v·ªÅ JSON:
{
  "prompt": "ƒê·ªÅ b√†i vi·∫øt",
  "vocabulary": [
    {"word": "t·ª´ v·ª±ng", "meaning": "nghƒ©a ti·∫øng Vi·ªát"}
  ]
}`;

        const response = await puterClient.ai.chat(prompt, { model: 'gpt-4o-mini' });
        let responseText = '';
        if (typeof response === 'string') {
          responseText = response;
        } else if (response && response.message && response.message.content) {
          responseText = response.message.content;
        }

        let jsonText = responseText.trim();
        if (jsonText.startsWith('```json')) {
          jsonText = jsonText.replace(/^```json\s*/, '').replace(/\s*```$/, '');
        } else if (jsonText.startsWith('```')) {
          jsonText = jsonText.replace(/^```\s*/, '').replace(/\s*```$/, '');
        }

        const result = JSON.parse(jsonText);

        // Display prompt
        document.getElementById('topicPromptText').textContent = result.prompt;
        document.getElementById('topicPrompt').classList.remove('hidden');

        // Display vocabulary
        const vocabEl = document.getElementById('topicVocabulary');
        if (result.vocabulary && result.vocabulary.length > 0) {
          vocabEl.innerHTML = `
            <h5 class="font-semibold text-purple-900 mb-2">G·ª£i √Ω t·ª´ v·ª±ng:</h5>
            <div class="flex flex-wrap gap-2">
              ${result.vocabulary.map(v => `
                <span class="px-3 py-1 bg-white border border-purple-200 rounded-lg text-sm cursor-pointer hover:bg-purple-100" 
                      onclick="addVocabularyToInput('${v.word}')" 
                      title="${v.meaning}">
                  ${v.word} <span class="text-gray-500 text-xs">(${v.meaning})</span>
                </span>
              `).join('')}
            </div>
          `;
        } else {
          vocabEl.innerHTML = '';
        }
      } catch (error) {
        console.error('Error generating topic prompt:', error);
        showError('L·ªói khi t·∫°o ƒë·ªÅ b√†i');
      } finally {
        showLoading(false);
      }
    }

    function addVocabularyToInput(word) {
      const input = document.getElementById('writingInput');
      const currentText = input.value;
      input.value = currentText + (currentText ? ' ' : '') + word + ' ';
      input.focus();
      document.getElementById('charCount').textContent = input.value.length;
    }

    function closeTopicPrompt() {
      document.getElementById('topicPrompt').classList.add('hidden');
    }

    // 2. Vocabulary Integration
    let vocabularyData = null;

    async function loadVocabularyData() {
      if (vocabularyData) return vocabularyData;
      try {
        const response = await fetch('/api/vocabulary/words?limit=10000&fields=Base Word,Level,Translate,Guideword');
        const data = await response.json();
        vocabularyData = new Map();
        data.data.forEach(word => {
          const baseWord = word['Base Word']?.toLowerCase();
          if (baseWord) {
            vocabularyData.set(baseWord, word);
          }
        });
        return vocabularyData;
      } catch (error) {
        console.error('Error loading vocabulary:', error);
        return new Map();
      }
    }

    function highlightVocabulary(text) {
      if (!vocabularyData || vocabularyData.size === 0) return text;
      
      const words = text.split(/(\s+|[.,!?;:])/);
      return words.map(word => {
        const cleanWord = word.toLowerCase().replace(/[.,!?;:()]/g, '');
        if (vocabularyData.has(cleanWord) && cleanWord.length > 2) {
          const wordData = vocabularyData.get(cleanWord);
          return `<span class="vocab-word bg-yellow-100 text-yellow-800 px-1 rounded cursor-pointer hover:bg-yellow-200" 
                         onclick="showWordDetailFromWriting('${wordData['Base Word']}')" 
                         title="${wordData.Translate || wordData.Guideword || ''}">
                  ${word}
                </span>`;
        }
        return word;
      }).join('');
    }

    async function showWordDetailFromWriting(word) {
      // Load vocabulary data if not loaded
      await loadVocabularyData();
      
      // Find word index
      try {
        const response = await fetch(`/api/vocabulary/words?search=${encodeURIComponent(word)}&limit=1`);
        const data = await response.json();
        if (data.data && data.data.length > 0) {
          // Open in new tab or modal
          window.open(`/learn?word=${encodeURIComponent(word)}`, '_blank');
        } else {
          // Fallback: open dictionary
          window.open(`https://dictionary.cambridge.org/dictionary/english/${encodeURIComponent(word)}`, '_blank');
        }
      } catch (error) {
        console.error('Error opening word detail:', error);
        window.open(`https://dictionary.cambridge.org/dictionary/english/${encodeURIComponent(word)}`, '_blank');
      }
    }

    // 3. Grammar Hints
    async function findGrammarHints(errorType, errorText) {
      try {
        const response = await fetch(`/api/grammar/points?search=${encodeURIComponent(errorType)}&limit=3`);
        const data = await response.json();
        return data.data || [];
      } catch (error) {
        console.error('Error finding grammar hints:', error);
        return [];
      }
    }

    async function displayGrammarHintsForErrors(errors) {
      const grammarErrors = errors.filter(e => e.type === 'grammar');
      if (grammarErrors.length === 0) return;

      // Find grammar hints for each error
      for (const error of grammarErrors) {
        const hints = await findGrammarHints(error.explanation || error.original, error.original);
        if (hints.length > 0) {
          error.grammarHints = hints;
        }
      }
    }

    // 4. Export & Download
    function exportWriting() {
      const original = document.getElementById('originalText').textContent;
      const corrected = document.getElementById('correctedText').textContent;
      const errors = Array.from(document.querySelectorAll('#errorsList > div')).map(el => ({
        original: el.querySelector('.error-highlight')?.textContent || '',
        corrected: el.querySelector('.correction-highlight')?.textContent || '',
        explanation: el.querySelector('.text-sm.text-gray-600')?.textContent || ''
      }));
      const suggestions = Array.from(document.querySelectorAll('#suggestionsList > div')).map(el => 
        el.querySelector('.text-gray-700')?.textContent || ''
      );
      const score = document.getElementById('scoreValue')?.textContent || 'N/A';
      const level = document.getElementById('levelValue')?.textContent || 'N/A';

      // Create markdown content
      const markdown = `# Writing Practice Report

## Score: ${score} | Level: ${level}

### Original Text
${original}

### Corrected Text
${corrected}

### Errors Found (${errors.length})
${errors.map((e, i) => `${i + 1}. **${e.original}** ‚Üí **${e.corrected}**\n   ${e.explanation}`).join('\n\n')}

### Suggestions
${suggestions.map((s, i) => `${i + 1}. ${s}`).join('\n')}

---
Generated on ${new Date().toLocaleString('vi-VN')}
`;

      // Download as text file
      const blob = new Blob([markdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `writing-practice-${Date.now()}.md`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Store original displayResults function
    const originalDisplayResultsFunction = displayResults;
    
    // Enhanced displayResults with vocabulary highlighting and grammar hints
    async function displayResultsEnhanced(result) {
      // Update writing progress
      updateWritingProgress(result);

      // Load vocabulary data
      await loadVocabularyData();
      
      // Find grammar hints for errors
      if (result.errors && result.errors.length > 0) {
        await displayGrammarHintsForErrors(result.errors);
      }

      // Call original function
      originalDisplayResultsFunction(result);

      // Highlight vocabulary in corrected text
      const correctedEl = document.getElementById('correctedText');
      if (correctedEl && result.corrected) {
        const highlighted = highlightVocabulary(result.corrected);
        correctedEl.innerHTML = highlighted;
      }

      // Add grammar hints to error display
      setTimeout(() => {
        const errorsListEl = document.getElementById('errorsList');
        if (errorsListEl && result.errors) {
          result.errors.forEach((error, index) => {
            if (error.grammarHints && error.grammarHints.length > 0) {
              const errorEl = errorsListEl.children[index];
              if (errorEl) {
                const flexEl = errorEl.querySelector('.flex-1');
                if (flexEl && !flexEl.querySelector('.grammar-hints')) {
                  const grammarHintsHtml = `
                    <div class="grammar-hints mt-2 pt-2 border-t border-gray-200">
                      <p class="text-xs font-semibold text-blue-600 mb-1">Grammar Hints:</p>
                      ${error.grammarHints.map(hint => `
                        <a href="/grammar?search=${encodeURIComponent(hint.Guideword)}" 
                           target="_blank"
                           class="block text-xs text-blue-600 hover:text-blue-800 mb-1">
                          <i class="fas fa-external-link-alt mr-1"></i>
                          ${escapeHtml(hint.Guideword || 'N/A')} (${escapeHtml(hint.Level || 'N/A')})
                        </a>
                      `).join('')}
                    </div>
                  `;
                  flexEl.insertAdjacentHTML('beforeend', grammarHintsHtml);
                }
              }
            }
          });
        }
      }, 100);
    }


    // Initialize
    document.getElementById('correctBtn').disabled = true;
    loadHistory();
    renderHistory();
    loadVocabularyData(); // Preload vocabulary

    // Load voices for Web Speech API
    if (checkWebSpeechAvailable()) {
      speechSynthesis.getVoices();
      speechSynthesis.onvoiceschanged = () => {
        speechSynthesis.getVoices();
      };
    }
  </script>
</body>
</html>

